<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FLR Staking Yield Analysis</title>
    <link rel="stylesheet" href="css/flr-analysis.css">
</head>
<body>
    <div class="container">
        <h1>FLR Staking Analysis</h1>
        
        <div class="content-wrapper">
            <!-- Input Block -->
            <div class="card">
                <h2>Inputs</h2>
                
                <!-- Price and Address Input Row -->
                <div class="price-address-row">
                    <!-- Price Display Card -->
                    <div class="price-display-small">
                        <div class="price-label">FLR/USD</div>
                        <div class="price-value" id="currentPrice" onclick="enableManualPrice()">Loading...</div>
                        <div class="manual-price-input" id="manualPriceInput" style="display: none;">
                            <input type="text" id="manualPrice" placeholder="0.0000" pattern="[0-9]*\.?[0-9]*" oninput="validateNumberInput(this); updateManualPrice();" onkeydown="handleManualPriceEnter(event)">
                            <span class="price-unit">USD</span>
                            <button type="button" class="price-confirm-btn" onclick="confirmManualPrice()">âœ“</button>
                        </div>
                    </div>
                    
                    <!-- FLR Address Input -->
                    <div class="address-input-section" id="addressInputSection">
                        <div class="address-label">FLR Address to pre-fetch data for some fields below</div>
                        <div class="address-input-wrapper">
                            <input type="text" id="flrAddress" placeholder="Enter FLR public address (0x...)" class="address-input" disabled>
                            <button type="button" class="fetch-data-btn" id="fetchDataBtn" onclick="fetchFLRData()" disabled>Fetch Data</button>
                        </div>
                        <div class="connection-status" id="connectionStatus">Checking connection...</div>
                    </div>
                </div>
                
                <!-- Two Column Layout -->
                <div class="input-columns">
                    <!-- Left Column: Staking Parameters -->
                    <div class="input-column">
                        <div class="section-header">
                            <label>basicParameters:<span class="string"></span></label>
                        </div>
                        
                        <!-- Staking Attributes Block -->
                        <div class="staking-block">
                            <h4>Staking Inputs</h4>
                            <div class="staking-inputs">
                                <div class="input-group">
                                    <label for="flrAmount">current amount: <span class="string">flr units</span></label>
                                    <div class="input-wrapper">
                                        <input type="text" id="flrAmount" placeholder="0.00" pattern="[0-9]*\.?[0-9]*" oninput="validateNumberInput(this);">
                                    </div>
                                </div>
                                
                                <div class="input-group">
                                    <label for="stakingYield">yield: <span class="string">flr/3.5days per flr</span>
                                        <span class="help-icon" title="Reward rate per FLR unit per 3.5 days - auto generated based on FTSO inputs (includes 20% FTSO commission)">(?)</span>
                                    </label>
                                    <div class="input-wrapper">
                                        <input type="text" id="stakingYield" placeholder="0.00000000" readonly style="cursor: default;">
                                        <span class="unit">FLR/3.5d</span>
                                    </div>
                                </div>
                                
                                <div class="input-group">
                                    <label>duration: <span class="string">time</span></label>
                                    <div class="time-inputs">
                                        <input type="number" id="years" placeholder="years" min="0" max="100" step="1">
                                        <input type="number" id="months" placeholder="months" min="0" max="11" step="1">
                                    </div>
                                </div>
                                
                                <div class="input-group">
                                    <label>frequency: <span class="string">claim/reinvest</span></label>
                                    <div class="claim-frequency-wrapper">
                                        <select id="claimFrequency" onchange="toggleCustomDays()">
                                            <option value="1">Daily</option>
                                            <option value="7">Weekly</option>
                                            <option value="30" selected>Monthly (30 days)</option>
                                            <option value="custom">Custom (days)</option>
                                        </select>
                                        <input type="number" id="customDays" placeholder="days" min="1" max="365" step="1" style="display: none;">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Additional Investment Block -->
                        <div class="staking-block">
                            <h4>Additional Investment</h4>
                            <div class="staking-inputs">
                                <div class="input-group" id="additionalInvestmentInputs">
                                    <label for="investmentAmount">amount: <span class="string">USD</span>
                                        <span class="help-icon" id="additionalInvestmentHelp" title="Requires FLR/USD price">(?)</span>
                                    </label>
                                    <div class="input-wrapper">
                                        <input type="text" id="investmentAmount" placeholder="0.00" pattern="[0-9]*\.?[0-9]*" oninput="validateNumberInput(this); updateAdditionalInvestment();">
                                        <span class="unit">$</span>
                                    </div>
                                </div>
                                
                                <div class="input-group" id="investmentFrequencyGroup">
                                    <label for="investmentFrequency">frequency: <span class="string">days</span></label>
                                    <div class="input-wrapper">
                                        <select id="investmentFrequency" onchange="updateAdditionalInvestment()">
                                            <option value="7">Weekly</option>
                                            <option value="14">Bi-weekly</option>
                                            <option value="30" selected>Monthly</option>
                                            <option value="90">Quarterly</option>
                                            <option value="365">Yearly</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right Column: FTSO Configuration -->
                    <div class="input-column">
                        <div class="section-header">
                            <label>ftso stakingInfo:<span class="string"></span></label>
                        </div>
                        
                        <!-- FTSO Count Toggle -->
                        <div class="staking-block">
                            <h4>FTSO Count</h4>
                            <div class="staking-inputs">
                                <div class="input-group">
                                    <div class="ftso-toggle-wrapper">
                                        <button type="button" class="ftso-toggle-btn active" data-count="1" onclick="setFTSOCount(1)">1 FTSO</button>
                                        <button type="button" class="ftso-toggle-btn" data-count="2" onclick="setFTSOCount(2)">2 FTSOs</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Reward Rate Toggle -->
                        <div class="staking-block">
                            <h4>Reward Rate</h4>
                            <div class="staking-inputs">
                                <div class="input-group" style="margin-bottom: 5px;">
                                    <div class="toggle-wrapper" style="margin-bottom: 2.5px;">
                                        <span class="toggle-label">manual</span>
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="rewardRateMode" onchange="toggleRewardRateMode()">
                                            <span class="toggle-slider"></span>
                                        </label>
                                        <span class="toggle-label" data-mode="auto" id="autoModeLabel">auto</span>
                                    </div>
                                    <div class="connection-status" id="flareApiStatus" style="margin-bottom: 2.5px;">Checking Flare API...</div>
                                </div>
                                
                                <!-- Manual Reward Rate Inputs -->
                                <div id="manualRewardRates" class="reward-rate-inputs" style="margin-top: 2.5px;">
                                    <div id="rewardRate1" class="input-group">
                                        <label for="ftsoReward1">ftso1 reward rate: <span class="string">flr/3.5days per flr</span></label>
                                        <div class="input-wrapper">
                                            <input type="text" id="ftsoReward1" placeholder="0.00000000" pattern="[0-9]*\.?[0-9]*" oninput="validateNumberInput(this); calculateAndUpdateYield();">
                                            <span class="unit">FLR/3.5d</span>
                                            <div class="ftso-dropdown" id="ftsoDropdown1">
                                                <div class="dropdown-search">
                                                    <input type="text" placeholder="Search FTSO providers..." oninput="filterFTSOProviders(1, this.value)">
                                                </div>
                                                <div class="dropdown-list" id="ftsoList1">
                                                    <!-- FTSO providers will be populated here -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div id="rewardRate2" class="input-group" style="display: none;">
                                        <label for="ftsoReward2">ftso2 reward rate: <span class="string">flr/3.5days per flr</span></label>
                                        <div class="input-wrapper">
                                            <input type="text" id="ftsoReward2" placeholder="0.00000000" pattern="[0-9]*\.?[0-9]*" oninput="validateNumberInput(this); calculateAndUpdateYield();">
                                            <span class="unit">FLR/3.5d</span>
                                            <div class="ftso-dropdown" id="ftsoDropdown2">
                                                <div class="dropdown-search">
                                                    <input type="text" placeholder="Search FTSO providers..." oninput="filterFTSOProviders(2, this.value)">
                                                </div>
                                                <div class="dropdown-list" id="ftsoList2">
                                                    <!-- FTSO providers will be populated here -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                </div>
                                
                                <!-- Auto Reward Rate Display -->
                                <div id="autoRewardRates" class="reward-rate-inputs" style="display: none;">
                                    <div style="padding: 15px; text-align: center; color: var(--muted); font-size: 0.75rem;">
                                        <p>Reward rates will be automatically fetched from Flare API</p>
                                        <div id="autoRewardStatus" class="connection-status"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 1 FTSO Mode -->
                        <div id="ftso1Mode" class="staking-block ftso-mode">
                            <h4>FTSO Allocation</h4>
                            <div class="staking-inputs">
                                <div class="split-display">
                                    <div class="split-item">
                                        <span class="split-label">Allocation:</span>
                                        <span>100%</span>
                                    </div>
                                </div>
                                
                                <!-- FTSO Information for 1 FTSO -->
                                <div class="ftso-info-table" style="margin-top: 7.2px; margin-bottom: 5.4px;">
                                    <div class="ftso-info-item">
                                        <span class="ftso-info-label">FTSO:</span>
                                        <span class="ftso-info-name" id="ftso1Name_single">Not selected</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 2 FTSO Mode -->
                        <div id="ftso2Mode" class="staking-block ftso-mode" style="display: none;">
                            <h4>FTSO Allocation</h4>
                            <div class="staking-inputs">
                                <div class="input-group">
                                    <label>allocation: <span class="string">ratio</span></label>
                                    <div class="slider-wrapper">
                                        <input type="range" id="ftsoRatioSlider" min="0" max="100" value="50" oninput="updateFTSORatioDisplay()">
                                        <div class="slider-labels" style="margin-bottom: 1px;">
                                            <span id="ftso1Label">FTSO 1: <span id="ftso1Ratio">50</span>%</span>
                                            <span id="ftso2Label">FTSO 2: <span id="ftso2Ratio">50</span>%</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- FTSO Information Table -->
                                <div class="ftso-info-table" style="margin-top: 1px; margin-bottom: 5.4px;">
                                    <div class="ftso-info-item">
                                        <span class="ftso-info-label">FTSO 1:</span>
                                        <span class="ftso-info-name" id="ftso1Name_dual">Not selected</span>
                                    </div>
                                    <div class="ftso-info-item">
                                        <span class="ftso-info-label">FTSO 2:</span>
                                        <span class="ftso-info-name" id="ftso2Name_dual">Not selected</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
                
                <button onclick="calculateYield()">Calculate()</button>
            </div>
            
            <!-- Output Block -->
            <div class="card">
                <h2>Results</h2>
                
                <div class="results-grid" id="results">
                    <!-- Row 1: Initial Amount, Additional Principal, Total Invested -->
                    <div class="result-item">
                        <div class="result-label">Initial Amount</div>
                        <div class="result-value">
                            <span id="initialAmount">0 FLR</span>
                            <span class="result-value-small" id="initialAmountUSD"></span>
                        </div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">Addn Principle/Period</div>
                        <div class="result-value">
                            <span id="additionalPerPeriod">0 FLR</span>
                            <span class="result-value-small" id="additionalPerPeriodUSD"></span>
                        </div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">Addn Principle</div>
                        <div class="result-value">
                            <span id="additionalPrincipal">0 FLR</span>
                            <span class="result-value-small" id="additionalPrincipalUSD"></span>
                        </div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">Total Invested</div>
                        <div class="result-value">
                            <span id="investedAmount">0 FLR</span>
                            <span class="result-value-small" id="investedAmountUSD"></span>
                        </div>
                    </div>
                    
                    <!-- Row 2: Staking Rewards, Staking APY -->
                    <div class="result-item">
                        <div class="result-label">Staking Rewards</div>
                        <div class="result-value">
                            <span id="stakingRewards">0 FLR</span>
                            <span class="result-value-small" id="stakingRewardsUSD"></span>
                        </div>
                    </div>
                    
                    <!-- Row 3: Final Total, Total APY -->
                    <div class="result-item">
                        <div class="result-label">Final Total</div>
                        <div class="result-value">
                            <span id="totalAmount">0 FLR</span>
                            <span class="result-value-small" id="totalAmountUSD"></span>
                        </div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">
                            Total APY
                            <span style="cursor: pointer; font-size: 0.75rem; color: var(--comment);" title="Total APY from FLR staking">(?)</span>
                        </div>
                        <div class="result-value" id="totalApy">0%</div>
                    </div>
                </div>

                <!-- Calculation Buttons -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10.8px; margin-top: 14.4px;">
                    <button class="expand-calculations-btn" onclick="showCalculationsModal()">
                        ðŸ“Š View Table
                    </button>
                    <button class="expand-calculations-btn" onclick="showGraphModal()">
                        ðŸ“ˆ View Graph
                    </button>
                </div>

                <div class="note">
                    Free script. Optional coffee support in FLR appreciated at 0x9A9cAed2d5B6e64164c68C93A4980eB7B74D6D07
                </div>
            </div>
        </div>
    </div>

    <!-- Calculations Modal -->
    <div id="calculationsModal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ðŸ“Š Period-by-Period Calculation Breakdown</div>
                <button class="close-btn" onclick="closeCalculationsModal()">&times;</button>
            </div>
            <div id="calculationsTableContainer">
                <!-- Table will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Graph Modal -->
    <div id="graphModal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ðŸ“ˆ FLR Growth Visualization</div>
                <button class="close-btn" onclick="closeGraphModal()">&times;</button>
            </div>
            <div id="graphContainer">
                <canvas id="growthChart" width="800" height="400"></canvas>
                <div id="chartLegend" style="margin-top: 14.4px; text-align: center; font-size: 0.75rem; color: var(--text);"></div>
            </div>
        </div>
    </div>

    <!-- Custom Error Modal -->
    <div id="errorModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 520px; margin: 25vh auto; padding: 8px 10px;">
            <div style="display: flex; align-items: center; gap: 6px;">
                <div id="errorMessage" style="flex: 1; font-size: 0.75rem; line-height: 1.2; color: var(--text);">
                    <!-- Error message will be populated here -->
                </div>
                <span onclick="closeErrorModal()" style="color: var(--muted); font-size: 10px; cursor: pointer; width: 8px; height: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;" onmouseover="this.style.color='var(--text)'" onmouseout="this.style.color='var(--muted)'">&times;</span>
            </div>
        </div>
    </div>

    <!-- Custom Success Modal -->
    <div id="successModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 520px; margin: 25vh auto; padding: 8px 10px;">
            <div style="display: flex; align-items: center; gap: 6px;">
                <div id="successMessage" style="flex: 1; font-size: 0.75rem; line-height: 1.2; color: var(--text);">
                    <!-- Success message will be populated here -->
                </div>
                <span onclick="closeSuccessModal()" style="color: var(--muted); font-size: 10px; cursor: pointer; width: 8px; height: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;" onmouseover="this.style.color='var(--text)'" onmouseout="this.style.color='var(--muted)'">&times;</span>
            </div>
        </div>
    </div>

    <script src="js/flr-analysis.js"></script>
</body>
</html>