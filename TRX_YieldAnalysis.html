<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRX Staking Yield Analysis</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #000000;
            --card: #0a0a0a;
            --card-hover: #0f0f0f;
            --muted: #9fb0d0;
            --text: #e9f0ff;
            --border: rgba(255,255,255,0.10);
            --good: #52d273;
            --warn: #ffcc66;
            --bad: #ff6b6b;
            /* VS Code syntax colors */
            --comment: #608b4e;
            --keyword: #569cd6;
            --string: #ce9178;
            --number: #b5cea8;
            --function: #dcdcaa;
            
            /* Responsive Base Unit System */
            /* Base unit scales from 1.8px on 14" screens (1366px) to larger/smaller on other sizes */
            --base-unit: clamp(1.2px, 0.132vw, 2.4px);
            
            /* Derived spacing units */
            --space-xs: calc(var(--base-unit) * 2);     /* ~3.6px */
            --space-sm: calc(var(--base-unit) * 3);     /* ~5.4px */
            --space-md: calc(var(--base-unit) * 4);     /* ~7.2px */
            --space-lg: calc(var(--base-unit) * 6);     /* ~10.8px */
            --space-xl: calc(var(--base-unit) * 8);     /* ~14.4px */
            --space-2xl: calc(var(--base-unit) * 10);   /* ~18px */
            --space-3xl: calc(var(--base-unit) * 12);   /* ~21.6px */
            --space-4xl: calc(var(--base-unit) * 16);   /* ~28.8px */
            
            /* Border radius units */
            --radius-sm: calc(var(--base-unit) * 2);    /* ~3.6px */
            --radius-md: calc(var(--base-unit) * 4);    /* ~7.2px */
            --radius-lg: calc(var(--base-unit) * 6);    /* ~10.8px */
            --radius-xl: calc(var(--base-unit) * 8);    /* ~14.4px */
            
            /* Font size units */
            --font-xs: calc(var(--base-unit) * 4.5);    /* ~8.1px */
            --font-sm: calc(var(--base-unit) * 5.25);   /* ~9.45px */
            --font-base: calc(var(--base-unit) * 6.5);  /* ~11.7px */
            --font-lg: calc(var(--base-unit) * 8.75);   /* ~15.75px */
            --font-xl: calc(var(--base-unit) * 12.5);   /* ~22.5px */
        }

        body {
            font-family: 'JetBrains Mono', monospace;
            background: #000000;
            background-image:
                radial-gradient(ellipse calc(var(--base-unit) * 800) calc(var(--base-unit) * 450) at 20% -10%, rgba(40, 40, 50, 1) 0%, transparent 40%),
                radial-gradient(ellipse calc(var(--base-unit) * 600) calc(var(--base-unit) * 400) at 80% 20%, rgba(35, 35, 45, 1) 0%, transparent 40%),
                radial-gradient(ellipse calc(var(--base-unit) * 500) calc(var(--base-unit) * 350) at 50% 50%, rgba(30, 30, 40, 0.8) 0%, transparent 50%),
                radial-gradient(ellipse calc(var(--base-unit) * 700) calc(var(--base-unit) * 450) at 90% 90%, rgba(45, 45, 55, 0.7) 0%, transparent 45%),
                linear-gradient(180deg, #000000 0%, #1a1a1f 50%, #000000 100%);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: calc(var(--space-2xl) * 0.5) var(--space-2xl);
            position: relative;
            overflow-x: hidden;
        }

        /* Subtle animated gradient overlay */
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at center, transparent 0%, rgba(50, 50, 60, 0.3) 50%, rgba(0, 0, 0, 0.8) 100%);
            animation: subtle-rotate 60s linear infinite;
            pointer-events: none;
            opacity: 0.5;
        }

        @keyframes subtle-rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .container {
            max-width: calc(var(--base-unit) * 900);
            width: 95%;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        h1 {
            text-align: center;
            margin-bottom: calc(var(--space-2xl) * 0.5);
            font-size: calc(var(--font-xl) * 1.2);
            font-weight: 600;
            color: #e9f0ff;
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: calc(var(--base-unit) * -0.25);
        }

        h1::before {
            content: '// ';
            color: var(--comment);
        }

        .content-wrapper {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-4xl);
            align-items: start;
        }

        /* Responsive Design - Multiple Breakpoints with Base Unit Scaling */
        @media (max-width: calc(var(--base-unit) * 778)) {
            .container {
                max-width: calc(var(--base-unit) * 667);
                width: 98%;
            }
            
            .input-columns {
                gap: calc(var(--space-lg) * 1.3);
            }
        }
        
        @media (max-width: calc(var(--base-unit) * 667)) {
            .container {
                max-width: calc(var(--base-unit) * 500);
            }
            
            .content-wrapper {
                gap: calc(var(--space-3xl) * 0.9);
            }
            
            .input-columns {
                grid-template-columns: 1fr;
                gap: var(--space-2xl);
            }
        }
        
        @media (max-width: calc(var(--base-unit) * 545)) {
            .content-wrapper {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: calc(var(--base-unit) * 500)) {
            .results-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            /* Adjust result item positioning for 2-column layout */
            .results-grid .result-item:nth-child(1) { grid-column: 1; grid-row: 1; }
            .results-grid .result-item:nth-child(2) { grid-column: 2; grid-row: 1; }
            .results-grid .result-item:nth-child(3) { grid-column: 1; grid-row: 2; }
            .results-grid .result-item:nth-child(4) { grid-column: 2; grid-row: 2; }
            .results-grid .result-item:nth-child(5) { grid-column: 1; grid-row: 3; }
            .results-grid .result-item:nth-child(6) { grid-column: 2; grid-row: 3; }
            .results-grid .result-item:nth-child(7) { grid-column: 1; grid-row: 4; }
            .results-grid .result-item:nth-child(8) { grid-column: 2; grid-row: 4; }
            .results-grid .result-item:nth-child(9) { grid-column: 1; grid-row: 5; }
            .results-grid .result-item:nth-child(10) { grid-column: 2; grid-row: 5; }
            .results-grid .result-item:nth-child(11) { grid-column: 1; grid-row: 6; }
            .results-grid .result-item:nth-child(12) { grid-column: 2; grid-row: 6; }
            .results-grid .result-item:nth-child(13) { grid-column: 1; grid-row: 7; }
            .results-grid .result-item:nth-child(14) { grid-column: 1 / 3; grid-row: 8; }
            .results-grid .result-item:nth-child(15) { grid-column: 1 / 3; grid-row: 9; }
        }
        
        @media (max-width: calc(var(--base-unit) * 427)) {
            body {
                padding: calc(var(--space-lg) * 1.1);
            }
            
            h1 {
                font-size: calc(var(--font-xl) * 1.28);
                margin-bottom: calc(var(--space-2xl) * 0.9);
            }
            
            .card {
                padding: calc(var(--space-2xl) * 0.74);
            }
            
            .price-address-row {
                flex-direction: column;
                gap: calc(var(--space-lg) * 1.3);
            }
            
            .price-display-small {
                min-width: auto;
                flex-shrink: 1;
            }
        }
        
        @media (max-width: calc(var(--base-unit) * 334)) {
            .results-grid {
                grid-template-columns: 1fr;
            }
            
            /* Reset all result items to single column */
            .results-grid .result-item {
                grid-column: 1 !important;
            }
            
            .container {
                width: 100%;
                padding: 0 calc(var(--space-md) * 1.1);
            }
            
            .card {
                padding: calc(var(--space-lg) * 1.3);
                margin: calc(var(--space-md) * 1.1) 0;
            }
            
            .input-group label {
                font-size: calc(var(--font-xs) * 1.01);
            }
            
            .input-group input,
            .input-group select {
                font-size: calc(var(--font-xs) * 1.01);
                padding: calc(var(--space-sm) * 1.5) calc(var(--space-lg) * 1.02);
            }
            
            button {
                padding: calc(var(--space-2xl) * 0.74);
                font-size: calc(var(--font-sm) * 1.71);
            }
        }

        .card {
            background: rgba(10, 10, 10, 0.85);
            background-image:
                linear-gradient(135deg, rgba(50, 50, 60, 0.3) 0%, transparent 50%),
                linear-gradient(225deg, rgba(40, 40, 50, 0.3) 0%, transparent 50%);
            border: 1px solid var(--border);
            border-radius: var(--radius-xl);
            padding: var(--space-3xl);
            box-shadow:
                0 calc(var(--base-unit) * 5) calc(var(--base-unit) * 14) rgba(0,0,0,0.8),
                inset 0 1px 0 rgba(255,255,255,0.03);
            backdrop-filter: blur(calc(var(--base-unit) * 5));
            overflow: hidden;
            position: relative;
        }

        /* Subtle gradient animation on cards */
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(86, 156, 214, 0.3), transparent);
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .card h2 {
            margin-bottom: var(--space-3xl);
            font-size: calc(var(--font-base) * 1.15);
            font-weight: 600;
            color: var(--keyword);
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: calc(var(--base-unit) * 0.1);
        }

        .card h2::before {
            content: '> ';
            color: var(--muted);
        }

        .price-display {
            background: rgba(255,255,255,0.03);
            background-image: radial-gradient(ellipse at center, rgba(70, 70, 80, 0.2) 0%, transparent 70%);
            border: 1px solid var(--border);
            border-radius: calc(var(--radius-lg) * 1.17);
            padding: calc(var(--radius-lg) * 1.17);
            margin-bottom: var(--space-2xl);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .price-label {
            font-size: calc(var(--font-xs) * 0.95);
            color: var(--muted);
            margin-bottom: calc(var(--space-sm) * 1.16);
            text-transform: uppercase;
            letter-spacing: calc(var(--base-unit) * 0.25);
            font-family: 'JetBrains Mono', monospace;
        }

        .price-value {
            font-size: calc(var(--font-lg) * 0.86);
            font-weight: 700;
            color: var(--number);
            font-family: 'JetBrains Mono', monospace;
        }

        .input-group {
            margin-bottom: var(--space-2xl);
        }

        .input-group label {
            display: block;
            margin-bottom: calc(var(--space-sm) * 1.5);
            font-size: calc(var(--base-unit) * 5.1);
            color: var(--text);
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
            white-space: nowrap;
        }

        .input-group label .string {
            color: var(--string);
        }

        .input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }


        .input-group input,
        .input-group select {
            width: 100%;
            background: rgba(255,255,255,0.04);
            background-image: linear-gradient(180deg, rgba(60, 60, 70, 0.2) 0%, transparent 100%);
            border: 1px solid var(--border);
            color: var(--text);
            padding: calc(var(--space-lg) * 0.8) calc(var(--space-lg) * 1.17);
            border-radius: calc(var(--space-lg) * 1.0);
            outline: none;
            font-size: calc(var(--base-unit) * 5.1);
            font-family: 'JetBrains Mono', monospace;
            transition: all 0.2s ease;
        }



        .input-group input:focus,
        .input-group select:focus {
            border-color: rgba(86, 156, 214, 0.6);
            box-shadow: 0 0 0 calc(var(--radius-sm) * 0.83) rgba(86, 156, 214, 0.15);
            background: rgba(255,255,255,0.06);
        }

        .input-group input::placeholder {
            color: rgba(159, 176, 208, 0.5);
        }

        .input-group .unit {
            position: absolute;
            right: calc(var(--space-lg) * 0.6);
            color: var(--string);
            pointer-events: none;
            font-family: 'JetBrains Mono', monospace;
            font-size: calc(var(--font-sm) * 1.2);
        }


        .time-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-lg);
        }

        .claim-frequency-wrapper {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: var(--space-lg);
            align-items: start;
        }

        .claim-frequency-wrapper.single-input {
            grid-template-columns: 1fr;
        }

        .claim-frequency-wrapper select {
            width: 100%;
        }

        .claim-frequency-wrapper input[type="number"] {
            width: 100%;
        }

        /* Two Column Layout - First column unchanged, second column twice as big */
        .input-columns {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: var(--space-2xl);
            margin-bottom: calc(var(--space-4xl) * 0.9);
            min-width: 0;
        }

        .input-column {
            min-width: 0;
        }

        /* Toggle Switch */
        .toggle-wrapper {
            display: flex;
            align-items: center;
            gap: calc(var(--space-sm) * 1.1);
            justify-content: center;
            margin-bottom: calc(var(--base-unit) * 0.11);
        }

        .toggle-label {
            font-size: calc(var(--base-unit) * 5.1);
            color: var(--text);
            font-family: 'JetBrains Mono', monospace;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: calc(var(--base-unit) * 20);
            height: calc(var(--base-unit) * 10);
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.08);
            background-image: linear-gradient(180deg, rgba(60, 60, 70, 0.2) 0%, transparent 100%);
            border: 1px solid var(--border);
            transition: 0.3s;
            border-radius: calc(var(--base-unit) * 10);
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: calc(var(--base-unit) * 6.5);
            width: calc(var(--base-unit) * 6.5);
            left: calc(var(--base-unit) * 1.2);
            bottom: calc(var(--base-unit) * 1.2);
            background: linear-gradient(180deg, rgba(86, 156, 214, 0.8), rgba(86, 156, 214, 0.6));
            border: 1px solid rgba(86, 156, 214, 0.4);
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 calc(var(--base-unit) * 1) var(--space-xs) rgba(0,0,0,0.3);
        }

        input:checked + .toggle-slider {
            background: rgba(86, 156, 214, 0.2);
            border-color: rgba(86, 156, 214, 0.4);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(calc(var(--base-unit) * 8.8));
            background: linear-gradient(180deg, rgba(86, 156, 214, 1), rgba(86, 156, 214, 0.8));
            box-shadow: 0 calc(var(--base-unit) * 1) var(--space-md) rgba(86, 156, 214, 0.4);
        }

        /* Slider Styles */
        .slider-wrapper {
            margin-top: var(--space-xs);
        }

        #ratioSlider,
        #restakeRatioSlider {
            width: 100%;
            height: var(--space-sm);
            border-radius: calc(var(--space-sm) / 2);
            background: rgba(255,255,255,0.08);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            margin-bottom: var(--space-lg);
        }

        #ratioSlider::-webkit-slider-thumb,
        #restakeRatioSlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: calc(var(--base-unit) * 9);
            height: calc(var(--base-unit) * 9);
            border-radius: 50%;
            background: linear-gradient(180deg, rgba(86, 156, 214, 0.9), rgba(86, 156, 214, 0.7));
            border: calc(var(--base-unit) * 1) solid rgba(86, 156, 214, 0.6);
            cursor: pointer;
            box-shadow: 0 calc(var(--base-unit) * 1) var(--space-sm) rgba(0,0,0,0.3);
        }

        #ratioSlider::-moz-range-thumb,
        #restakeRatioSlider::-moz-range-thumb {
            width: calc(var(--base-unit) * 9);
            height: calc(var(--base-unit) * 9);
            border-radius: 50%;
            background: linear-gradient(180deg, rgba(86, 156, 214, 0.9), rgba(86, 156, 214, 0.7));
            border: calc(var(--base-unit) * 1) solid rgba(86, 156, 214, 0.6);
            cursor: pointer;
            box-shadow: 0 calc(var(--base-unit) * 1) var(--space-sm) rgba(0,0,0,0.3);
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: var(--font-xs);
            color: var(--muted);
            margin-bottom: var(--space-lg);
            font-family: 'JetBrains Mono', monospace;
        }

        .split-display {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: var(--space-lg);
            margin-top: var(--space-md);
            margin-bottom: calc(var(--base-unit) * -1.11);
        }

        .split-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--space-sm);
            font-size: var(--font-xs);
            font-family: 'JetBrains Mono', monospace;
        }

        .split-item:last-child {
            margin-bottom: 0;
        }

        .split-label {
            color: var(--muted);
        }

        /* Staking Mode Styles */
        .staking-mode {
            transition: opacity 0.3s ease;
        }

        /* Disabled State - Only for staking content, not section titles */
        .staking-content.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .staking-content.disabled input,
        .staking-content.disabled .toggle-switch,
        .staking-content.disabled .slider-wrapper,
        .staking-content.disabled .split-display {
            cursor: not-allowed;
        }

        /* Legacy disabled state for full column (keep for compatibility) */
        #stakingSplitColumn.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        #stakingSplitColumn.disabled input,
        #stakingSplitColumn.disabled .toggle-switch {
            cursor: not-allowed;
        }

        /* Keep help icons clickable even when disabled */
        #stakingSplitColumn.disabled .help-icon,
        #stakingSplitColumn.disabled #stakingSplitHelp {
            pointer-events: auto;
            opacity: 1;
            cursor: pointer;
        }

        /* Validation Message */
        .validation-message {
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid rgba(255, 107, 107, 0.3);
            border-radius: calc(var(--space-sm) * 1.5);
            padding: calc(var(--space-sm) * 1.5) calc(var(--space-lg) * 1.0);
            font-size: calc(var(--font-xs) * 0.95);
            color: var(--bad);
            font-family: 'JetBrains Mono', monospace;
            margin-top: calc(var(--space-sm) * 1.5);
        }



        /* Manual Price Input */
        .manual-price-input {
            display: flex;
            align-items: center;
            gap: calc(var(--space-sm) * 1.5);
            margin-top: calc(var(--space-lg) * 1.0);
            padding: calc(var(--space-sm) * 1.5) calc(var(--space-lg) * 1.0);
            background: rgba(255,255,255,0.04);
            border: 1px solid var(--border);
            border-radius: calc(var(--space-sm) * 1.5);
        }

        .manual-price-input input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text);
            font-size: calc(var(--font-sm) * 1.5);
            font-family: 'JetBrains Mono', monospace;
            outline: none;
            padding: calc(var(--radius-sm) * 1.0) 0;
        }

        .price-unit {
            font-size: calc(var(--font-xs) * 0.95);
            color: var(--string);
            font-family: 'JetBrains Mono', monospace;
        }

        .price-confirm-btn {
            width: calc(var(--base-unit) * 12);
            height: calc(var(--base-unit) * 12);
            background: rgba(82, 210, 115, 0.2);
            border: 1px solid rgba(82, 210, 115, 0.4);
            border-radius: calc(var(--radius-sm) * 1.0);
            color: var(--good);
            font-size: calc(var(--font-xs) * 0.95);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            margin: 0;
            padding: 0;
        }

        .price-confirm-btn:hover {
            background: rgba(82, 210, 115, 0.3);
            border-color: rgba(82, 210, 115, 0.6);
        }

        .price-value {
            cursor: pointer;
            transition: opacity 0.2s ease;
        }

        .price-value:hover {
            opacity: 0.8;
        }

        /* Price and Address Row Layout */
        .price-address-row {
            display: flex;
            gap: var(--space-2xl);
            margin-bottom: calc(var(--space-4xl) * 0.85);
            margin-top: calc(var(--base-unit) * -4.9);
            align-items: flex-start;
        }

        /* Small Price Display Card */
        .price-display-small {
            background: rgba(255,255,255,0.03);
            background-image: radial-gradient(ellipse at center, rgba(70, 70, 80, 0.2) 0%, transparent 70%);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: var(--space-lg) var(--space-md) calc(var(--space-lg) - calc(var(--base-unit) * 1.1)) var(--space-md);
            text-align: center;
            position: relative;
            overflow: hidden;
            min-width: calc(var(--base-unit) * 57);
            flex-shrink: 0;
        }

        /* Address Input Section */
        .address-input-section {
            flex: 1;
            min-width: 0;
        }

        .address-label {
            font-size: calc(var(--font-xs) * 0.95);
            color: var(--muted);
            margin-bottom: calc(var(--space-sm) * 1.16);
            margin-left: calc(var(--base-unit) * 1.1);
            text-transform: uppercase;
            letter-spacing: calc(var(--base-unit) * 0.25);
            font-family: 'JetBrains Mono', monospace;
        }

        .address-input-wrapper {
            display: flex;
            gap: calc(var(--space-lg) * 1.0);
            align-items: center;
            transform: translateY(calc(var(--base-unit) * -0.83));
        }

        .address-input {
            flex: 3;
            min-width: 0;
            background: rgba(255,255,255,0.04);
            background-image: linear-gradient(180deg, rgba(60, 60, 70, 0.2) 0%, transparent 100%);
            border: 1px solid var(--border);
            color: var(--text);
            padding: calc(var(--space-md) * 0.7) calc(var(--space-lg) * 0.8);
            border-radius: calc(var(--radius-md) * 1.0);
            outline: none;
            font-size: calc(var(--base-unit) * 5.1);
            font-family: 'JetBrains Mono', monospace;
            transition: all 0.2s ease;
        }

        .address-input:focus {
            border-color: rgba(86, 156, 214, 0.6);
            box-shadow: 0 0 0 calc(var(--radius-sm) * 0.83) rgba(86, 156, 214, 0.15);
            background: rgba(255,255,255,0.06);
        }

        .address-input::placeholder {
            color: rgba(159, 176, 208, 0.5);
        }

        .address-input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(255,255,255,0.02);
        }

        .fetch-data-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(82, 210, 115, 0.3);
            pointer-events: none;
        }

        .address-input-section.offline {
            opacity: 0.6;
        }

        .connection-status {
            font-size: calc(var(--font-xs) * 0.95);
            color: var(--muted);
            margin-top: calc(var(--base-unit) * 2.1);
            margin-left: calc(var(--base-unit) * 1.1);
            font-family: 'JetBrains Mono', monospace;
        }

        .connection-status.online {
            color: var(--good);
        }

        .connection-status.offline {
            color: var(--bad);
        }

        .fetch-data-btn {
            background: linear-gradient(180deg, rgba(82, 210, 115, 0.8), rgba(82, 210, 115, 0.6));
            border: 1px solid rgba(82, 210, 115, 0.4);
            color: var(--text);
            padding: calc(var(--space-md) * 0.7) calc(var(--space-lg) * 0.8);
            border-radius: calc(var(--radius-md) * 1.0);
            font-size: calc(var(--font-xs) * 1.1);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'JetBrains Mono', monospace;
            text-transform: uppercase;
            letter-spacing: calc(var(--base-unit) * 0.17);
            white-space: nowrap;
            flex: 1;
            max-width: calc(var(--base-unit) * 50);
            margin-top: 0;
            height: auto;
            box-sizing: border-box;
        }

        .fetch-data-btn:hover {
            background: linear-gradient(180deg, rgba(82, 210, 115, 0.9), rgba(82, 210, 115, 0.7));
            border-color: rgba(82, 210, 115, 0.6);
            transform: translateY(calc(var(--base-unit) * -0.5));
            box-shadow: 0 calc(var(--radius-sm) * 1.0) calc(var(--space-lg) * 1.0) rgba(82, 210, 115, 0.3);
        }

        .fetch-data-btn:active {
            transform: translateY(0);
        }


        /* Section Headers */
        .section-header {
            margin-bottom: calc(var(--space-lg) * 1.0);
            margin-top: calc(var(--space-xl) * 1.0);
        }

        .section-header:first-child {
            margin-top: 0;
        }

        .section-header label {
            display: flex;
            align-items: center;
            gap: calc(var(--space-sm) * 1.5);
            font-size: calc(var(--base-unit) * 5.1);
            color: var(--text);
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
            margin-bottom: 0;
        }

        /* Help Icons */
        .help-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: var(--space-xl);
            height: var(--space-xl);
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 50%;
            color: var(--muted);
            font-size: calc(var(--font-xs) * 0.85);
            font-family: 'JetBrains Mono', monospace;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .help-icon:hover {
            background: rgba(86, 156, 214, 0.2);
            border-color: rgba(86, 156, 214, 0.4);
            color: var(--keyword);
        }

        /* Additional Investment Section - Only disable content, not title */
        .additional-investment-content.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .additional-investment-content.disabled input,
        .additional-investment-content.disabled select {
            cursor: not-allowed;
        }

        /* Legacy disabled states for individual elements (keep for compatibility) */
        #additionalInvestmentInputs.disabled,
        #investmentFrequencyGroup.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        #additionalInvestmentInputs.disabled input,
        #investmentFrequencyGroup.disabled select {
            cursor: not-allowed;
        }

        /* Keep help icons clickable even when disabled */
        #additionalInvestmentInputs.disabled .help-icon,
        #additionalInvestmentInputs.disabled #additionalInvestmentHelp {
            pointer-events: auto;
            opacity: 1;
            cursor: pointer;
        }

        /* Help icon visibility states */
        .help-icon.visible {
            opacity: 1;
        }

        .help-icon.hidden {
            opacity: 0.3;
        }

        /* Lending Section Styles */
        .lending-block {
            background: rgba(255,255,255,0.02);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: calc(var(--space-xl) * 0.85);
            margin-bottom: var(--space-xl);
            overflow: hidden;
            box-sizing: border-box;
        }

        .lending-block h4 {
            margin: 0 0 calc(var(--space-xl) - calc(var(--base-unit) * 2.78)) 0;
            font-size: var(--font-xs);
            color: var(--keyword);
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: calc(var(--base-unit) * 0.25);
        }

        .lending-inputs {
            display: grid;
            grid-template-columns: 1fr;
            gap: calc(var(--space-lg) * 0.9);
        }

        .lending-block .input-group {
            margin-bottom: calc(var(--space-lg) * 0.25);
            box-sizing: border-box;
        }

        /* Current Staking values mode - match other input pair spacing */
        #valuesMode .input-group {
            margin-bottom: calc(var(--space-2xl) - calc(var(--base-unit) * 1.11));
        }

        /* Reduce gaps between inputs and toggles in lending and growth sections to match current staking */
        #lendingColumn .lending-block:first-child .toggle-wrapper {
            margin-top: calc(var(--base-unit) * -2.22);
        }

        #lendingColumn .lending-block:last-child .toggle-wrapper {
            margin-top: calc(var(--base-unit) * -2.22);
        }

        .lending-block .input-group:last-child {
            margin-bottom: 0;
        }

        /* Specific sizing for lending block inputs to prevent overflow */
        .lending-block .input-group label {
            font-size: calc(var(--base-unit) * 5.1);
            margin-bottom: var(--space-sm);
            line-height: 1.2;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .lending-block .input-group input,
        .lending-block .input-group select {
            font-size: calc(var(--base-unit) * 5.1);
            padding: calc(var(--space-md) * 0.7) var(--space-lg);
            box-sizing: border-box;
            width: 100%;
            max-width: 100%;
        }


        .lending-block .unit {
            font-size: calc(var(--font-sm) * 1.2);
        }

        #claimFrequency,
        #investmentFrequency,
        #growthPeriod {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: calc(100% - calc(var(--space-lg) * 0.3)) center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: calc(var(--space-lg) * 2.2);
        }

        /* Lending Toggle States */
        #lendingColumn.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        #lendingColumn.disabled input,
        #lendingColumn.disabled select {
            cursor: not-allowed;
        }

        /* Keep help icons and toggle switch clickable even when disabled */
        #lendingColumn.disabled .help-icon,
        #lendingColumn.disabled #lendingHelp,
        #lendingColumn.disabled .toggle-switch,
        #lendingColumn.disabled .toggle-wrapper {
            pointer-events: auto;
            opacity: 1;
            cursor: pointer;
        }
        
        /* Ensure toggle slider is also clickable when disabled */
        #lendingColumn.disabled .toggle-slider {
            pointer-events: auto;
            cursor: pointer;
        }

        /* Lending Inputs Container disabled state - only affects the input fields, not the title or toggle */
        #lendingInputsContainer.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        #lendingInputsContainer.disabled input,
        #lendingInputsContainer.disabled label {
            cursor: not-allowed;
        }

        /* Growth Inputs Container disabled state - only affects the input fields, not the title or toggle */
        #growthInputsContainer.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        #growthInputsContainer.disabled input,
        #growthInputsContainer.disabled select,
        #growthInputsContainer.disabled label {
            cursor: not-allowed;
        }

        button {
            width: 100%;
            padding: calc(var(--space-2xl) * 0.5);
            margin-top: 0;
            appearance: none;
            border: 1px solid var(--border);
            background: linear-gradient(180deg, rgba(86, 156, 214, 0.8), rgba(86, 156, 214, 0.6));
            color: var(--text);
            font-size: calc(var(--font-base) * 0.85);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'JetBrains Mono', monospace;
            text-transform: uppercase;
            letter-spacing: calc(var(--base-unit) * 0.25);
            border-radius: var(--radius-lg);
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            transition: width 0.3s, height 0.3s;
            transform: translate(-50%, -50%);
        }

        button:hover::before {
            width: 270px;
            height: 270px;
        }

        button:hover {
            border-color: rgba(86, 156, 214, 0.8);
            transform: translateY(-0.9px);
            box-shadow: 0 3.6px 10.8px rgba(86, 156, 214, 0.3);
            background: linear-gradient(180deg, rgba(86, 156, 214, 0.9), rgba(86, 156, 214, 0.7));
        }

        button:active {
            transform: translateY(0);
        }

        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
            grid-template-rows: auto auto auto auto auto;
            gap: calc(var(--space-lg) * 1.0);
            margin-top: calc(var(--base-unit) * -4.9);
        }

        /* First row: Initial Amount, Additional Per Period, Additional Principal, Total Invested, Growth Rate - 25% smaller using internal sizing */
        .results-grid .result-item:nth-child(1) { grid-column: 1; grid-row: 1; }
        .results-grid .result-item:nth-child(2) { grid-column: 2; grid-row: 1; }
        .results-grid .result-item:nth-child(3) { grid-column: 3; grid-row: 1; }
        .results-grid .result-item:nth-child(4) { grid-column: 4; grid-row: 1; }
        .results-grid .result-item:nth-child(5) { grid-column: 5; grid-row: 1; }
        
        /* Internal sizing for first row - 25% smaller with 5% height increase */
        .results-grid .result-item:nth-child(-n+5) {
            padding: calc(var(--space-lg) * 1.0) calc(var(--space-md) * 1.35);
            min-height: calc(var(--base-unit) * 31.67);
        }

        .results-grid .result-item:nth-child(-n+5) .result-label {
            font-size: calc(var(--font-xs) * 0.75);
            margin-bottom: calc(var(--space-sm) * 1.1);
            height: calc(var(--space-lg) * 1.0);
        }

        .results-grid .result-item:nth-child(-n+5) .result-value {
            font-size: calc(var(--font-sm) * 1.76);
        }

        .results-grid .result-item:nth-child(-n+5) .result-value-small {
            font-size: calc(var(--font-xs) * 0.73);
            margin-top: calc(var(--base-unit) * 1.5);
        }

        /* Second row: Staking Rewards, Staking APY, Staking Income Monthly - 3 cards, 25% smaller */
        .results-grid .result-item:nth-child(6) { grid-column: 1 / 3; grid-row: 2; }
        .results-grid .result-item:nth-child(7) { grid-column: 3; grid-row: 2; }
        .results-grid .result-item:nth-child(8) { grid-column: 4 / 6; grid-row: 2; }
        
        /* Internal sizing for second row - 25% smaller with 5% height increase */
        .results-grid .result-item:nth-child(6),
        .results-grid .result-item:nth-child(7),
        .results-grid .result-item:nth-child(8) {
            padding: calc(var(--space-lg) * 1.0) calc(var(--space-md) * 1.35);
            min-height: calc(var(--base-unit) * 31.67);
        }

        .results-grid .result-item:nth-child(6) .result-label,
        .results-grid .result-item:nth-child(7) .result-label,
        .results-grid .result-item:nth-child(8) .result-label {
            font-size: calc(var(--font-xs) * 0.75);
            margin-bottom: calc(var(--space-sm) * 1.1);
            height: calc(var(--space-lg) * 1.0);
        }

        .results-grid .result-item:nth-child(6) .result-value,
        .results-grid .result-item:nth-child(7) .result-value,
        .results-grid .result-item:nth-child(8) .result-value {
            font-size: calc(var(--font-sm) * 1.76);
        }

        .results-grid .result-item:nth-child(6) .result-value-small,
        .results-grid .result-item:nth-child(7) .result-value-small,
        .results-grid .result-item:nth-child(8) .result-value-small {
            font-size: calc(var(--font-xs) * 0.73);
            margin-top: calc(var(--base-unit) * 1.5);
        }

        /* Third row: Energy Income, Bandwidth Income, Total Lending Income, Lending APY, Lending Income Monthly - 5 cards, 25% smaller */
        .results-grid .result-item:nth-child(9) { grid-column: 1; grid-row: 3; }
        .results-grid .result-item:nth-child(10) { grid-column: 2; grid-row: 3; }
        .results-grid .result-item:nth-child(11) { grid-column: 3; grid-row: 3; }
        .results-grid .result-item:nth-child(12) { grid-column: 4; grid-row: 3; }
        .results-grid .result-item:nth-child(13) { grid-column: 5; grid-row: 3; }
        
        /* Internal sizing for third row - 25% smaller with 5% height increase */
        .results-grid .result-item:nth-child(9),
        .results-grid .result-item:nth-child(10),
        .results-grid .result-item:nth-child(11),
        .results-grid .result-item:nth-child(12),
        .results-grid .result-item:nth-child(13) {
            padding: calc(var(--space-lg) * 1.0) calc(var(--space-md) * 1.35);
            min-height: calc(var(--base-unit) * 31.67);
        }

        .results-grid .result-item:nth-child(9) .result-label,
        .results-grid .result-item:nth-child(10) .result-label,
        .results-grid .result-item:nth-child(11) .result-label,
        .results-grid .result-item:nth-child(12) .result-label,
        .results-grid .result-item:nth-child(13) .result-label {
            font-size: calc(var(--font-xs) * 0.75);
            margin-bottom: calc(var(--space-sm) * 1.1);
            height: calc(var(--space-lg) * 1.0);
        }

        .results-grid .result-item:nth-child(9) .result-value,
        .results-grid .result-item:nth-child(10) .result-value,
        .results-grid .result-item:nth-child(11) .result-value,
        .results-grid .result-item:nth-child(12) .result-value,
        .results-grid .result-item:nth-child(13) .result-value {
            font-size: calc(var(--font-sm) * 1.76);
        }

        .results-grid .result-item:nth-child(9) .result-value-small,
        .results-grid .result-item:nth-child(10) .result-value-small,
        .results-grid .result-item:nth-child(11) .result-value-small,
        .results-grid .result-item:nth-child(12) .result-value-small,
        .results-grid .result-item:nth-child(13) .result-value-small {
            font-size: calc(var(--font-xs) * 0.73);
            margin-top: calc(var(--base-unit) * 1.5);
        }

        /* Fourth row: Final Total, Combined APY (centered) - adjust for 5 columns with reduced height */
        .results-grid .result-item:nth-child(14) {
            grid-column: 1 / 4;
            grid-row: 4;
            padding: calc(var(--space-lg) * 0.8) var(--space-lg);
            min-height: calc(var(--base-unit) * 32);
        }
        .results-grid .result-item:nth-child(15) {
            grid-column: 4 / 6;
            grid-row: 4;
            padding: calc(var(--space-lg) * 0.8) var(--space-lg);
            min-height: calc(var(--base-unit) * 32);
        }


        /* Network Parameters Styles */
        .network-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: calc(var(--space-sm) * 1.21) 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-family: 'JetBrains Mono', monospace;
        }

        .network-item:last-child {
            border-bottom: none;
        }

        .network-label {
            font-size: calc(var(--base-unit) * 5.25);
            color: var(--muted);
            font-weight: 500;
        }

        .network-value {
            font-size: calc(var(--base-unit) * 5.25);
            color: var(--good);
            font-weight: 600;
        }

        .result-item {
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: var(--space-xl) var(--space-lg);
            background: rgba(255,255,255,0.02);
            background-image: linear-gradient(135deg, rgba(60, 60, 70, 0.2) 0%, transparent 100%);
            transition: all 0.2s ease;
            min-width: 0;
            min-height: calc(var(--base-unit) * 40);
        }

        .result-item:hover {
            background: rgba(255,255,255,0.04);
            transform: translateY(calc(var(--base-unit) * -0.5));
            box-shadow: 0 var(--space-xs) var(--space-lg) rgba(0,0,0,0.5);
        }

        .result-label {
            font-size: var(--font-xs);
            color: var(--muted);
            margin-bottom: var(--space-md);
            text-transform: uppercase;
            letter-spacing: calc(var(--base-unit) * 0.25);
            font-family: 'JetBrains Mono', monospace;
            height: var(--space-xl);
            line-height: 1;
            display: flex;
            align-items: center;
            text-align: left;
        }

        .result-value {
            font-size: var(--font-lg);
            font-weight: 700;
            color: var(--good);
            font-family: 'JetBrains Mono', monospace;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .result-value-small {
            font-size: calc(var(--font-xs) * 0.85);
            color: #ce9178; /* Orange color for USD values */
            margin-top: var(--space-xs);
            font-weight: 500;
            display: block;
            line-height: 1.2;
        }

        /* Expand Calculations Button */
        .expand-calculations-btn {
            width: 100%;
            padding: var(--space-lg);
            margin-top: var(--space-xl);
            background: rgba(255,255,255,0.04);
            border: 1px solid var(--border);
            border-radius: calc(var(--radius-md) * 1.25);
            color: var(--text);
            font-size: var(--font-sm);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'JetBrains Mono', monospace;
        }

        .expand-calculations-btn:hover {
            background: rgba(255,255,255,0.08);
            border-color: rgba(86, 156, 214, 0.4);
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            overflow-y: auto;
        }

        .modal-content {
            position: relative;
            background: var(--card);
            margin: var(--space-2xl) auto;
            padding: calc(var(--base-unit) * 12);
            border-radius: calc(var(--radius-xl) * 1.0);
            border: 1px solid var(--border);
            max-width: 90%;
            width: calc(var(--base-unit) * 600);
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-2xl);
            padding-bottom: calc(var(--space-xl) * 1.0);
            border-bottom: 1px solid var(--border);
        }

        .modal-title {
            font-size: calc(var(--font-lg) * 0.72);
            font-weight: 600;
            color: var(--keyword);
            font-family: 'JetBrains Mono', monospace;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text);
            font-size: calc(var(--font-lg) * 0.86);
            cursor: pointer;
            padding: calc(var(--radius-sm) * 1.0) calc(var(--space-sm) * 1.5);
            border-radius: calc(var(--radius-sm) * 1.0);
            transition: background 0.2s ease;
        }

        .close-btn:hover {
            background: rgba(255,255,255,0.1);
        }

        /* Calculations Table */
        .calculations-table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'JetBrains Mono', monospace;
            font-size: calc(var(--font-sm) * 1.5);
        }

        .calculations-table th,
        .calculations-table td {
            padding: calc(var(--space-lg) * 1.0) calc(var(--space-sm) * 1.5);
            text-align: right;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .calculations-table th:first-child,
        .calculations-table td:first-child {
            text-align: left;
        }

        .calculations-table th {
            background: rgba(255,255,255,0.05);
            color: var(--keyword);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: calc(var(--base-unit) * 0.25);
            font-size: calc(var(--font-xs) * 0.95);
        }

        .calculations-table td {
            color: var(--text);
        }

        .calculations-table tr:hover {
            background: rgba(255,255,255,0.02);
        }

        .period-number {
            color: var(--string);
            font-weight: 600;
        }

        .amount-value {
            color: var(--good);
            font-weight: 500;
        }

        .total-row {
            background: rgba(86, 156, 214, 0.1) !important;
            border-top: calc(var(--base-unit) * 1.0) solid rgba(86, 156, 214, 0.3);
        }

        .total-row td {
            font-weight: 600;
            color: var(--keyword);
        }


        .note {
            margin-top: var(--space-2xl);
            padding: calc(var(--space-xl) * 1.0);
            background: rgba(96, 139, 78, 0.1);
            background-image: linear-gradient(135deg, rgba(96, 139, 78, 0.05) 0%, transparent 100%);
            border: 1px solid rgba(96, 139, 78, 0.3);
            border-radius: calc(var(--space-lg) * 1.0);
            font-size: calc(var(--font-sm) * 1.5);
            color: var(--text);
            line-height: 1.6;
            font-family: 'JetBrains Mono', monospace;
        }

        /* Tooltip styles - COMPLETELY OPAQUE BLACK WITH BRIGHT WHITE TEXT */
        .help-icon,
        [title],
        *[title] {
            cursor: pointer;
            position: relative;
        }

        /* FORCE ALL TOOLTIPS TO BE OPAQUE BLACK - COMPREHENSIVE SELECTOR */
        .help-icon:hover::after,
        [title]:hover::after,
        *[title]:hover::after,
        #additionalInvestmentHelp:hover::after,
        #stakingSplitHelp:hover::after,
        #lendingHelp:hover::after,
        .result-label [title]:hover::after,
        .result-label span[title]:hover::after,
        #lendingColumn .help-icon:hover::after,
        #lendingColumn.disabled .help-icon:hover::after,
        #lendingColumn.disabled #lendingHelp:hover::after,
        #stakingSplitColumn .help-icon:hover::after,
        #stakingSplitColumn.disabled .help-icon:hover::after,
        #stakingSplitColumn.disabled #stakingSplitHelp:hover::after,
        #additionalInvestmentInputs .help-icon:hover::after,
        #additionalInvestmentInputs.disabled .help-icon:hover::after,
        #additionalInvestmentInputs.disabled #additionalInvestmentHelp:hover::after {
            content: attr(title) !important;
            position: absolute !important;
            bottom: 120% !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            background: #000000 !important;
            background-color: #000000 !important;
            background-image: none !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
            color: #ffffff !important;
            padding: calc(var(--space-sm) * 1.5) calc(var(--space-lg) * 1.17) !important;
            border-radius: calc(var(--space-sm) * 1.5) !important;
            border: calc(var(--base-unit) * 1.0) solid #cccccc !important;
            font-size: calc(var(--font-xs) * 0.95) !important;
            white-space: nowrap !important;
            z-index: 9999 !important;
            box-shadow: 0 calc(var(--space-sm) * 1.1) var(--space-2xl) rgba(0,0,0,0.9) !important;
            font-family: 'JetBrains Mono', monospace !important;
            max-width: calc(var(--base-unit) * 140) !important;
            white-space: normal !important;
            pointer-events: none !important;
            opacity: 1 !important;
            display: block !important;
            visibility: visible !important;
            font-weight: 400 !important;
        }

        /* FORCE ALL TOOLTIP ARROWS TO BE OPAQUE BLACK - COMPREHENSIVE SELECTOR */
        .help-icon:hover::before,
        [title]:hover::before,
        *[title]:hover::before,
        #additionalInvestmentHelp:hover::before,
        #stakingSplitHelp:hover::before,
        #lendingHelp:hover::before,
        .result-label [title]:hover::before,
        .result-label span[title]:hover::before,
        #lendingColumn .help-icon:hover::before,
        #lendingColumn.disabled .help-icon:hover::before,
        #lendingColumn.disabled #lendingHelp:hover::before,
        #stakingSplitColumn .help-icon:hover::before,
        #stakingSplitColumn.disabled .help-icon:hover::before,
        #stakingSplitColumn.disabled #stakingSplitHelp:hover::before,
        #additionalInvestmentInputs .help-icon:hover::before,
        #additionalInvestmentInputs.disabled .help-icon:hover::before,
        #additionalInvestmentInputs.disabled #additionalInvestmentHelp:hover::before {
            content: '' !important;
            position: absolute !important;
            bottom: 110% !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            width: 0 !important;
            height: 0 !important;
            border-left: calc(var(--space-sm) * 1.1) solid transparent !important;
            border-right: calc(var(--space-sm) * 1.1) solid transparent !important;
            border-top: calc(var(--space-sm) * 1.1) solid #000000 !important;
            z-index: 9999 !important;
            pointer-events: none !important;
            opacity: 1 !important;
            display: block !important;
            visibility: visible !important;
        }

        /* OVERRIDE ANY COMPETING STYLES ON DISABLED STATES */
        .disabled .help-icon:hover::after,
        .disabled [title]:hover::after,
        #lendingColumn.disabled .help-icon:hover::after,
        #lendingColumn.disabled #lendingHelp:hover::after,
        #stakingSplitColumn.disabled .help-icon:hover::after,
        #stakingSplitColumn.disabled #stakingSplitHelp:hover::after,
        #additionalInvestmentInputs.disabled .help-icon:hover::after,
        #additionalInvestmentInputs.disabled #additionalInvestmentHelp:hover::after {
            background: #000000 !important;
            background-color: #000000 !important;
            color: #ffffff !important;
            opacity: 1 !important;
            visibility: visible !important;
        }

        .disabled .help-icon:hover::before,
        .disabled [title]:hover::before,
        #lendingColumn.disabled .help-icon:hover::before,
        #lendingColumn.disabled #lendingHelp:hover::before,
        #stakingSplitColumn.disabled .help-icon:hover::before,
        #stakingSplitColumn.disabled #stakingSplitHelp:hover::before,
        #additionalInvestmentInputs.disabled .help-icon:hover::before,
        #additionalInvestmentInputs.disabled #additionalInvestmentHelp:hover::before {
            border-top-color: #000000 !important;
            opacity: 1 !important;
            visibility: visible !important;
        }

        /* Remove animation to prevent opacity issues */
        @keyframes tooltipFadeIn {
            from {
                opacity: 1 !important;
                transform: translateX(-50%) translateY(0) !important;
            }
            to {
                opacity: 1 !important;
                transform: translateX(-50%) translateY(0) !important;
            }
        }

        /* Ensure tooltips don't get cut off on edges */
        .help-icon:hover::after {
            min-width: max-content !important;
        }

        /* Specific positioning for help icons in tight spaces */
        .section-header .help-icon:hover::after {
            bottom: 130% !important;
            left: 0 !important;
            transform: translateX(0) !important;
        }

        .section-header .help-icon:hover::before {
            bottom: 120% !important;
            left: 8px !important;
            transform: translateX(0) !important;
        }

        /* Column 2 (staking split) tooltip positioning - centered above question mark */
        #stakingSplitColumn .help-icon:hover::after,
        #stakingSplitColumn #stakingSplitHelp:hover::after,
        #stakingSplitColumn.disabled #stakingSplitHelp:hover::after {
            bottom: 130% !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            max-width: 270px !important;
        }

        #stakingSplitColumn .help-icon:hover::before,
        #stakingSplitColumn #stakingSplitHelp:hover::before,
        #stakingSplitColumn.disabled #stakingSplitHelp:hover::before {
            bottom: 120% !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
        }

        /* Column 3 (lending) tooltip positioning - prevent right edge cutoff */
        #lendingColumn #lendingHelp:hover::after,
        #lendingColumn.disabled #lendingHelp:hover::after {
            bottom: 130% !important;
            left: auto !important;
            right: 120% !important;
            transform: translateX(0) !important;
            max-width: 200px !important;
        }

        #lendingColumn #lendingHelp:hover::before,
        #lendingColumn.disabled #lendingHelp:hover::before {
            bottom: 120% !important;
            left: auto !important;
            right: 112% !important;
            transform: translateX(0) !important;
        }

        /* Additional Investment tooltip positioning - to the right of question mark */
        #additionalInvestmentHelp:hover::after {
            bottom: auto !important;
            left: 100% !important;
            top: 50% !important;
            transform: translateY(-50%) !important;
            margin-left: calc(var(--space-sm) * 1.5) !important;
            max-width: calc(var(--base-unit) * 100) !important;
        }

        #additionalInvestmentHelp:hover::before {
            bottom: auto !important;
            left: 94% !important;
            top: 50% !important;
            transform: translateY(-50%) !important;
            border-top: calc(var(--space-sm) * 1.1) solid transparent !important;
            border-bottom: calc(var(--space-sm) * 1.1) solid transparent !important;
            border-right: calc(var(--space-sm) * 1.1) solid #000000 !important;
            border-left: none !important;
        }

        /* Lending Income Monthly (13th result card) tooltip positioning - prevent right edge cutoff */
        .results-grid .result-item:nth-child(13) .result-label [title]:hover::after,
        .results-grid .result-item:nth-child(13) .result-label span[title]:hover::after {
            bottom: 120% !important;
            left: auto !important;
            right: 0% !important;
            transform: translateX(0) !important;
            max-width: calc(var(--base-unit) * 139) !important;
        }

        .results-grid .result-item:nth-child(13) .result-label [title]:hover::before,
        .results-grid .result-item:nth-child(13) .result-label span[title]:hover::before {
            bottom: 110% !important;
            left: auto !important;
            right: 20% !important;
            transform: translateX(0) !important;
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>TRX STAKING ANALYSIS</h1>
        
        <div class="content-wrapper">
            <!-- Input Block -->
            <div class="card">
                <h2>INPUTS</h2>
                
                <!-- Price and Address Input Row -->
                <div class="price-address-row">
                    <!-- Price Display Card -->
                    <div class="price-display-small">
                        <div class="price-label">TRX/USD</div>
                        <div class="price-value" id="currentPrice" onclick="enableManualPrice()">Loading...</div>
                        <div class="manual-price-input" id="manualPriceInput" style="display: none;">
                            <input type="text" id="manualPrice" placeholder="0.0000" pattern="[0-9]*\.?[0-9]*" oninput="validateNumberInput(this); updateManualPrice();" onkeydown="handleManualPriceEnter(event)">
                            <span class="price-unit">USD</span>
                            <button type="button" class="price-confirm-btn" onclick="confirmManualPrice()"></button>
                        </div>
                    </div>
                    
                    <!-- TRX Address Input -->
                    <div class="address-input-section" id="addressInputSection">
                        <div class="address-label">TRX Address to pre-fetch data for some feilds below</div>
                        <div class="address-input-wrapper">
                            <input type="text" id="trxAddress" placeholder="Enter TRX public address (T...)" class="address-input" disabled>
                            <button type="button" class="fetch-data-btn" id="fetchDataBtn" onclick="fetchTRXData()" disabled>Fetch Data</button>
                        </div>
                        <div class="connection-status" id="connectionStatus">Checking connection...</div>
                    </div>
                </div>
                
                <!-- Two Column Layout -->
                <div class="input-columns">
                    <!-- Left Column: Staking Parameters -->
                    <div class="input-column">
                        
                        <!-- Staking Attributes Block -->
                        <div class="lending-block" style="margin-top: calc(var(--base-unit) * -2.8);">
                            <h4>Staking Inputs</h4>
                            <div class="lending-inputs">
                                <div class="input-group">
                                    <label for="trxAmount">current amount: <span class="string">trx units</span></label>
                                    <div class="input-wrapper">
                                        <input type="text" id="trxAmount" placeholder="0.00" pattern="[0-9]*\.?[0-9]*" oninput="validateNumberInput(this); updateStakingSplit();">
                                    </div>
                                </div>
                                
                                <div class="input-group">
                                    <label for="stakingYield">yield: <span class="string">percentage</span></label>
                                    <div class="input-wrapper">
                                        <input type="text" id="stakingYield" placeholder="0.00" pattern="[0-9]*\.?[0-9]*" oninput="validateNumberInput(this)">
                                        <span class="unit">%</span>
                                    </div>
                                </div>
                                
                                <div class="input-group">
                                    <label>duration: <span class="string">time</span></label>
                                    <div class="time-inputs">
                                        <input type="number" id="years" placeholder="years" min="0" max="100" step="1">
                                        <input type="number" id="months" placeholder="months" min="0" max="11" step="1">
                                    </div>
                                </div>
                                
                                <div class="input-group">
                                    <label>frequency: <span class="string">claim/reinvest</span></label>
                                    <div class="claim-frequency-wrapper">
                                        <select id="claimFrequency" onchange="toggleCustomDays()">
                                            <option value="1">Daily</option>
                                            <option value="7">Weekly</option>
                                            <option value="30" selected>Monthly (30 days)</option>
                                            <option value="custom">Custom (days)</option>
                                        </select>
                                        <input type="number" id="customDays" placeholder="days" min="1" max="365" step="1" style="display: none;">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Additional Investment Block -->
                        <div class="lending-block">
                            <h4>Additional Investment <span id="additionalInvestmentHelp" style="cursor: pointer; font-size: 0.75rem; color: var(--comment);" title="Requires TRX/USD price">(?)</span></h4>
                            <div class="lending-inputs additional-investment-content">
                                <div class="input-group">
                                    <label for="investmentAmount">amount: <span class="string">USD</span></label>
                                    <div class="input-wrapper">
                                        <input type="text" id="investmentAmount" placeholder="0.00" pattern="[0-9]*\.?[0-9]*" oninput="validateNumberInput(this); updateAdditionalInvestment();">
                                        <span class="unit">$</span>
                                    </div>
                                </div>
                                
                                <div class="input-group">
                                    <label for="investmentFrequency">frequency: <span class="string">days</span></label>
                                    <div class="input-wrapper">
                                        <select id="investmentFrequency" onchange="updateAdditionalInvestment()">
                                            <option value="7">Weekly</option>
                                            <option value="14">Bi-weekly</option>
                                            <option value="30" selected>Monthly</option>
                                            <option value="90">Quarterly</option>
                                            <option value="365">Yearly</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Second Column: Restructured Layout -->
                    <div class="input-column" id="stakingSplitColumn">
                        <!-- Row Block 1: Current Split and Restake Split side by side -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16.2px; margin-bottom: 2px; margin-top: calc(var(--base-unit) * -2.8);">
                            <!-- Current Staking Block -->
                            <div class="lending-block">
                                <h4>Current Staking <span style="cursor: pointer; font-size: 0.75rem; color: var(--comment);" title="Requires TRX amount > 0">(?)</span></h4>
                                <div class="lending-inputs staking-content">
                                    <div class="input-group">
                                        <div class="toggle-wrapper">
                                            <span class="toggle-label">ratio</span>
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="stakingSplitMode" onchange="toggleStakingMode()">
                                                <span class="toggle-slider"></span>
                                            </label>
                                            <span class="toggle-label">values</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Ratio Mode -->
                                    <div id="ratioMode" class="staking-mode">
                                        <div class="input-group">
                                            <label>energy/bandwidth: <span class="string">ratio</span></label>
                                            <div class="slider-wrapper">
                                                <input type="range" id="ratioSlider" min="0" max="100" value="50" oninput="updateRatioDisplay()">
                                                <div class="slider-labels">
                                                    <span>Energy: <span id="energyRatio">50</span>%</span>
                                                    <span>Bandwidth: <span id="bandwidthRatio">50</span>%</span>
                                                </div>
                                                <div class="split-display">
                                                    <div class="split-item">
                                                        <span class="split-label">Energy TRX:</span>
                                                        <span id="energyTrx">0</span>
                                                    </div>
                                                    <div class="split-item">
                                                        <span class="split-label">Bandwidth TRX:</span>
                                                        <span id="bandwidthTrx">0</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Values Mode -->
                                    <div id="valuesMode" class="staking-mode" style="display: none;">
                                        <div class="input-group">
                                            <label for="energyAmount">energy: <span class="string">trx units</span></label>
                                            <div class="input-wrapper">
                                                <input type="text" id="energyAmount" placeholder="0.00" pattern="[0-9]*\.?[0-9]*" oninput="validateNumberInput(this); autoCalculateSplit(this, 'energy');">
                                            </div>
                                        </div>
                                        
                                        <div class="input-group">
                                            <label for="bandwidthAmount">bandwidth: <span class="string">trx units</span></label>
                                            <div class="input-wrapper">
                                                <input type="text" id="bandwidthAmount" placeholder="0.00" pattern="[0-9]*\.?[0-9]*" oninput="validateNumberInput(this); autoCalculateSplit(this, 'bandwidth');">
                                            </div>
                                        </div>
                                        
                                        <div class="validation-message" id="splitValidation" style="display: none;"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Restake Split Block -->
                            <div class="lending-block">
                                <h4>Restake Split <span style="cursor: pointer; font-size: 0.75rem; color: var(--comment);" title="Requires TRX amount > 0">(?)</span></h4>
                                <div class="lending-inputs staking-content">
                                    <div class="input-group">
                                        <div style="text-align: center; margin-top: calc(var(--base-unit) * 3.9); font-size: calc(var(--base-unit) * 5.2); color: var(--text); font-family: 'JetBrains Mono', monospace;">only ratio supported</div>
                                    </div>
                                    <div class="input-group" style="margin-top: 6.4px;">
                                        <label>energy/bandwidth: <span class="string">ratio</span></label>
                                        <div class="slider-wrapper">
                                            <input type="range" id="restakeRatioSlider" min="0" max="100" value="50" oninput="updateRestakeRatioDisplay()">
                                            <div class="slider-labels">
                                                <span>Energy: <span id="restakeEnergyRatio">50</span>%</span>
                                                <span>Bandwidth: <span id="restakeBandwidthRatio">50</span>%</span>
                                            </div>
                                            <div class="split-display">
                                                <div class="split-item">
                                                    <span class="split-label">Energy Restake:</span>
                                                    <span id="restakeEnergyPercent">50%</span>
                                                </div>
                                                <div class="split-item">
                                                    <span class="split-label">Bandwidth Restake:</span>
                                                    <span id="restakeBandwidthPercent">50%</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Row Block 2: Lending Section -->
                        <div id="lendingColumn">
                            
                            <!-- Lending Block -->
                            <div class="lending-block">
                                <h4>Lending Inputs</h4>
                                <div class="input-group">
                                    <div class="toggle-wrapper">
                                        <span class="toggle-label">disabled</span>
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="lendingMode" onchange="toggleLendingMode()">
                                            <span class="toggle-slider"></span>
                                        </label>
                                        <span class="toggle-label">enabled</span>
                                    </div>
                                </div>
                                
                                <!-- Energy and Bandwidth Lending side by side -->
                                <div id="lendingInputsContainer" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16.2px;">
                                    <!-- Energy Lending -->
                                    <div class="lending-inputs">
                                        <div class="input-group">
                                            <label for="energyLendingRate">energy lending rate: <span class="string">sun/day</span></label>
                                            <div class="input-wrapper">
                                                <input type="text" id="energyLendingRate" placeholder="0.00" pattern="[0-9]*\.?[0-9]*" oninput="validateNumberInput(this)">
                                                <span class="unit">SUN</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Bandwidth Lending -->
                                    <div class="lending-inputs">
                                        <div class="input-group">
                                            <label for="bandwidthLendingRate">bandwidth lending rate: <span class="string">sun/day</span></label>
                                            <div class="input-wrapper">
                                                <input type="text" id="bandwidthLendingRate" placeholder="0.00" pattern="[0-9]*\.?[0-9]*" oninput="validateNumberInput(this)">
                                                <span class="unit">SUN</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        
                            <!-- TRX Growth Inputs Block - separate from lending -->
                            <div class="lending-block">
                                <h4>TRX Growth Inputs</h4>
                                <div class="input-group">
                                    <div class="toggle-wrapper">
                                        <span class="toggle-label">disabled</span>
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="growthMode" onchange="toggleGrowthMode()">
                                            <span class="toggle-slider"></span>
                                        </label>
                                        <span class="toggle-label">enabled</span>
                                    </div>
                                </div>
                                
                                <!-- Growth Rate and Growth Period side by side -->
                                <div id="growthInputsContainer" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16.2px;">
                                    <!-- Growth Rate -->
                                    <div class="lending-inputs">
                                        <div class="input-group">
                                            <label for="growthRate">growth rate: <span class="string">percentage</span></label>
                                            <div class="input-wrapper">
                                                <input type="text" id="growthRate" placeholder="0.00" pattern="[0-9]*\.?[0-9]*" oninput="validateNumberInput(this)">
                                                <span class="unit">%</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Growth Period -->
                                    <div class="lending-inputs">
                                        <div class="input-group">
                                            <label for="growthPeriod">growth period: <span class="string">time</span></label>
                                            <div class="input-wrapper">
                                                <select id="growthPeriod">
                                                    <option value="30">Monthly (30 days)</option>
                                                    <option value="90">Quarterly (90 days)</option>
                                                    <option value="180">Half Yearly (180 days)</option>
                                                    <option value="365" selected>Yearly (365 days)</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Footer Note moved above calculate button -->
                <div class="note" style="margin-top: calc(var(--space-xl) * -1.5); margin-bottom: var(--space-lg); font-size: var(--font-sm); padding: calc(var(--space-xl) * 0.5) calc(var(--space-xl) * 1.0);">
                    Find this useful? Appreciate coffee addiction support  (TVYaURNqrpmCCJJr3Lrm5pTRnyiB8jSWc4)
                </div>

                <button onclick="calculateYield()">Calculate()</button>
            </div>
            
            <!-- Output Block -->
            <div class="card">
                <h2>RESULTS</h2>
                
                <div class="results-grid" id="results">
                    <!-- Row 1: Initial Amount, Additional Principal, Total Invested, Growth Rate -->
                    <div class="result-item">
                        <div class="result-label">Initial Amount</div>
                        <div class="result-value">
                            <span id="initialAmount">0 TRX</span>
                            <span class="result-value-small" id="initialAmountUSD">($0.00)</span>
                        </div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">Addn Principle/Period</div>
                        <div class="result-value">
                            <span id="additionalPerPeriod">0 TRX</span>
                            <span class="result-value-small" id="additionalPerPeriodUSD">($0.00)</span>
                        </div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">Addn Principle</div>
                        <div class="result-value">
                            <span id="additionalPrincipal">0 TRX</span>
                            <span class="result-value-small" id="additionalPrincipalUSD">($0.00)</span>
                        </div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">Total Invested</div>
                        <div class="result-value">
                            <span id="investedAmount">0 TRX</span>
                            <span class="result-value-small" id="investedAmountUSD">($0.00)</span>
                        </div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">Growth Rate</div>
                        <div class="result-value" id="growthRate">0%</div>
                    </div>
                    
                    <!-- Row 2: Staking Rewards, Staking APY -->
                    <div class="result-item">
                        <div class="result-label">Staking Rewards</div>
                        <div class="result-value">
                            <span id="stakingRewards">0 TRX</span>
                            <span class="result-value-small" id="stakingRewardsUSD">($0.00)</span>
                        </div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">
                            Staking APY
                            <span style="cursor: pointer; font-size: 0.75rem; color: var(--comment);" title="APY from staking rewards based on claim frequency">(?)</span>
                        </div>
                        <div class="result-value" id="stakingApy">0%</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">
                            Staking Income Monthly
                            <span style="cursor: pointer; font-size: 0.75rem; color: var(--comment);" title="Monthly TRX income from staking rewards at end of projection period">(?)</span>
                        </div>
                        <div class="result-value">
                            <span id="stakingIncomeMonthly">0 TRX</span>
                            <span class="result-value-small" id="stakingIncomeMonthlyUSD">($0.00)</span>
                        </div>
                    </div>
                    
                    <!-- Row 3: Energy Income, Bandwidth Income, Total Lending Income, Lending APY -->
                    <div class="result-item">
                        <div class="result-label">Energy Income</div>
                        <div class="result-value">
                            <span id="energyIncome">0 TRX</span>
                            <span class="result-value-small" id="energyIncomeUSD">($0.00)</span>
                        </div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">Bandwidth Income</div>
                        <div class="result-value">
                            <span id="bandwidthIncome">0 TRX</span>
                            <span class="result-value-small" id="bandwidthIncomeUSD">($0.00)</span>
                        </div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">Total Lending</div>
                        <div class="result-value">
                            <span id="lendingIncome">0 TRX</span>
                            <span class="result-value-small" id="lendingIncomeUSD">($0.00)</span>
                        </div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">
                            Lending APY
                            <span style="cursor: pointer; font-size: 0.75rem; color: var(--comment);" title="APY from lending energy/bandwidth based on rates and payout frequency">(?)</span>
                        </div>
                        <div class="result-value" id="lendingApy">0%</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">
                            Lending Income Monthly
                            <span style="cursor: pointer; font-size: 0.75rem; color: var(--comment);" title="Monthly TRX income from lending energy/bandwidth at end of projection period">(?)</span>
                        </div>
                        <div class="result-value">
                            <span id="lendingIncomeMonthly">0 TRX</span>
                            <span class="result-value-small" id="lendingIncomeMonthlyUSD">($0.00)</span>
                        </div>
                    </div>
                    
                    <!-- Row 4: Final Total, Combined APY -->
                    <div class="result-item">
                        <div class="result-label">Final Total</div>
                        <div class="result-value">
                            <span id="totalAmount">0 TRX</span>
                            <span class="result-value-small" id="totalAmountUSD">($0.00)</span>
                        </div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">
                            Combined APY
                            <span style="cursor: pointer; font-size: 0.75rem; color: var(--comment);" title="Total APY combining staking and lending yields">(?)</span>
                        </div>
                        <div class="result-value" id="combinedApy">0%</div>
                    </div>
                    
                </div>

                <!-- Calculation Buttons -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-lg); margin-top: calc(var(--base-unit) * -6.1);">
                    <button class="expand-calculations-btn" onclick="showCalculationsModal()">
                         View Table
                    </button>
                    <button class="expand-calculations-btn" onclick="showGraphModal()">
                         View Graph
                    </button>
                </div>

                <!-- Network Parameters Section -->
                <div style="margin-top: calc(var(--space-xl) + calc(var(--base-unit) * 3.34));">
                    <h2 style="margin-bottom: calc(var(--space-lg) * 0.75 + var(--base-unit) * 2.78); font-size: calc(var(--font-base) * 1.15);">NETWORK PARAMETERS</h2>
                    <div style="background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: var(--radius-xl); padding: var(--space-xl); display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-2xl);">
                        <!-- Column 1: Network Values -->
                        <div>
                            <div class="network-item">
                                <span class="network-label">Total Net Weight:</span>
                                <span class="network-value" id="totalNetWeight">Loading...</span>
                            </div>
                            <div class="network-item">
                                <span class="network-label">Total Energy Weight:</span>
                                <span class="network-value" id="totalEnergyWeight">Loading...</span>
                            </div>
                            <div class="network-item">
                                <span class="network-label">Total Net Limit:</span>
                                <span class="network-value" id="totalNetLimit">Loading...</span>
                            </div>
                            <div class="network-item">
                                <span class="network-label">Total Energy Limit:</span>
                                <span class="network-value" id="totalEnergyLimit">Loading...</span>
                            </div>
                            <div class="network-item">
                                <span class="network-label">Energy/stakedTRX:</span>
                                <span class="network-value" id="energyPerStakedTRX">Loading...</span>
                            </div>
                            <div class="network-item">
                                <span class="network-label">Bandwidth/stakedTRX:</span>
                                <span class="network-value" id="bandwidthPerStakedTRX">Loading...</span>
                            </div>
                        </div>
                        
                        <!-- Column 2: Available Resources -->
                        <div>
                            <div class="network-item">
                                <span class="network-label">Energy Initial:</span>
                                <span class="network-value" id="energyAvailable">0</span>
                            </div>
                            <div class="network-item">
                                <span class="network-label">Bandwidth Initial:</span>
                                <span class="network-value" id="bandwidthAvailable">0</span>
                            </div>
                            <div class="network-item">
                                <span class="network-label">Energy Final:</span>
                                <span class="network-value" id="energyFinal">0</span>
                            </div>
                            <div class="network-item">
                                <span class="network-label">Bandwidth Final:</span>
                                <span class="network-value" id="bandwidthFinal">0</span>
                            </div>
                        </div>
                    </div>
                </div>
                

            </div>
        </div>
    </div>

    <!-- Calculations Modal -->
    <div id="calculationsModal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title"> Period-by-Period Calculation Breakdown</div>
                <button class="close-btn" onclick="closeCalculationsModal()">&times;</button>
            </div>
            <div id="calculationsTableContainer">
                <!-- Table will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Graph Modal -->
    <div id="graphModal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content" style="max-width: 95%; width: 1400px;">
            <div class="modal-header">
                <div class="modal-title"> Growth Visualization</div>
                <button class="close-btn" onclick="closeGraphModal()">&times;</button>
            </div>
            <div id="graphContainer" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <!-- TRX Chart -->
                <div style="text-align: center;">
                    <h3 style="margin-bottom: 10px; font-size: 1rem; color: var(--keyword); font-family: 'JetBrains Mono', monospace;">TRX Balance Growth</h3>
                    <canvas id="trxChart" width="600" height="400"></canvas>
                </div>
                <!-- USD Chart -->
                <div style="text-align: center;">
                    <h3 style="margin-bottom: 10px; font-size: 1rem; color: var(--keyword); font-family: 'JetBrains Mono', monospace;">USD Value Growth</h3>
                    <canvas id="usdChart" width="600" height="400"></canvas>
                </div>
            </div>
            <div id="chartLegend" style="margin-top: 14.4px; text-align: center; font-size: 0.75rem; color: var(--text);"></div>
        </div>
    </div>

    <!-- Custom Error Modal -->
    <div id="errorModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: calc(var(--base-unit) * 289); margin: 25vh auto; padding: calc(var(--space-md) * 1.11) calc(var(--space-lg) * 0.93);">
            <div style="display: flex; align-items: center; gap: calc(var(--space-sm) * 1.22);">
                <div id="errorMessage" style="flex: 1; font-size: calc(var(--font-sm) * 1.43); line-height: 1.2; color: var(--text);">
                    <!-- Error message will be populated here -->
                </div>
                <span onclick="closeErrorModal()" style="color: var(--muted); font-size: calc(var(--space-lg) * 0.93); cursor: pointer; width: calc(var(--space-md) * 1.11); height: calc(var(--space-md) * 1.11); display: flex; align-items: center; justify-content: center; flex-shrink: 0;" onmouseover="this.style.color='var(--text)'" onmouseout="this.style.color='var(--muted)'">&times;</span>
            </div>
        </div>
    </div>

    <!-- Custom Success Modal -->
    <div id="successModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: calc(var(--base-unit) * 289); margin: 25vh auto; padding: calc(var(--space-md) * 1.11) calc(var(--space-lg) * 0.93);">
            <div style="display: flex; align-items: center; gap: calc(var(--space-sm) * 1.22);">
                <div id="successMessage" style="flex: 1; font-size: calc(var(--font-sm) * 1.43); line-height: 1.2; color: var(--text);">
                    <!-- Success message will be populated here -->
                </div>
                <span onclick="closeSuccessModal()" style="color: var(--muted); font-size: calc(var(--space-lg) * 0.93); cursor: pointer; width: calc(var(--space-md) * 1.11); height: calc(var(--space-md) * 1.11); display: flex; align-items: center; justify-content: center; flex-shrink: 0;" onmouseover="this.style.color='var(--text)'" onmouseout="this.style.color='var(--muted)'">&times;</span>
            </div>
        </div>
    </div>

    <script>
        let currentTRXPrice = null;
        const walletAddress = 'T9yD14Nj9j7xAB4dbGeiX9h8unkKHxuWwb';

        // Fetch TRX price on load
        async function getTRXPrice() {
            try {
                const response = await fetch(
                    "https://api.coingecko.com/api/v3/simple/price?ids=tron&vs_currencies=usd"
                );
                const data = await response.json();
                currentTRXPrice = data.tron.usd;
                document.getElementById("currentPrice").textContent = "$" + currentTRXPrice.toFixed(4);
                updateAdditionalInvestmentState();
                // Update connection status to show successful price fetch
                updatePriceConnectionStatus(true);
            } catch (err) {
                document.getElementById("currentPrice").textContent = "-- USD";
                console.error("Error loading TRX price:", err);
                updateAdditionalInvestmentState();
                // Update connection status to show manual entry instruction
                updatePriceConnectionStatus(false);
            }
        }

        // Fetch TRON network statistics using the same approach as test2.html
        async function getTRONNetworkStats() {
            try {
                const response = await fetch('https://api.trongrid.io/wallet/getaccountresource', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        address: walletAddress,
                        visible: true
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log('TRON Network Data:', data); // Debug log
                
                // Update network statistics with formatted numbers
                document.getElementById('totalNetWeight').textContent = formatNetworkNumber(data.TotalNetWeight || 0);
                document.getElementById('totalEnergyWeight').textContent = formatNetworkNumber(data.TotalEnergyWeight || 0);
                document.getElementById('totalNetLimit').textContent = formatNetworkNumber(data.TotalNetLimit || 0);
                document.getElementById('totalEnergyLimit').textContent = formatNetworkNumber(data.TotalEnergyLimit || 0);
                
                // Calculate and display Energy/stakedTRX and Bandwidth/stakedTRX
                const energyPerStaked = (data.TotalEnergyLimit && data.TotalEnergyWeight) ?
                    (data.TotalEnergyLimit / data.TotalEnergyWeight) : 0;
                const bandwidthPerStaked = (data.TotalNetLimit && data.TotalNetWeight) ?
                    (data.TotalNetLimit / data.TotalNetWeight) : 0;
                
                document.getElementById('energyPerStakedTRX').textContent = formatNetworkNumber(energyPerStaked);
                document.getElementById('bandwidthPerStakedTRX').textContent = formatNetworkNumber(bandwidthPerStaked);
                
                // Update energy and bandwidth availability after network data is loaded
                updateEnergyBandwidthDisplay();
                
                // Enable address input since we have internet connectivity
                updateAddressInputStatus(true);
                
            } catch (err) {
                console.error('Error loading TRON network stats:', err);
                document.getElementById('totalNetWeight').textContent = '--';
                document.getElementById('totalEnergyWeight').textContent = '--';
                document.getElementById('totalNetLimit').textContent = '--';
                document.getElementById('totalEnergyLimit').textContent = '--';
                document.getElementById('energyPerStakedTRX').textContent = '--';
                document.getElementById('bandwidthPerStakedTRX').textContent = '--';
                
                // Disable address input since we don't have internet connectivity
                updateAddressInputStatus(false);
            }
        }

        function updateAddressInputStatus(isOnline) {
            const statusElement = document.getElementById('connectionStatus');
            const addressInput = document.getElementById('trxAddress');
            const fetchButton = document.getElementById('fetchDataBtn');
            const addressSection = document.getElementById('addressInputSection');
            
            if (isOnline) {
                // Check if TRX price is available
                if (currentTRXPrice !== null && currentTRXPrice > 0) {
                    statusElement.textContent = 'Online - Address input enabled';
                } else {
                    statusElement.textContent = 'Online - Address input enabled, TRX price: click price box to enter manually';
                }
                statusElement.className = 'connection-status online';
                addressInput.disabled = false;
                fetchButton.disabled = false;
                addressSection.classList.remove('offline');
            } else {
                if (currentTRXPrice !== null && currentTRXPrice > 0) {
                    statusElement.textContent = 'Offline - Click TRX price box to enter manually if needed';
                } else {
                    statusElement.textContent = 'Offline - Click TRX price box to enter manually';
                }
                statusElement.className = 'connection-status offline';
                addressInput.disabled = true;
                fetchButton.disabled = true;
                addressSection.classList.add('offline');
            }
        }

        function updatePriceConnectionStatus(priceOnline) {
            // This function is deprecated - status is now handled by updateAddressInputStatus
            // Keep for compatibility but delegate to main status function
            // The connection status is now unified and based on API availability
            console.log('Price connection status update:', priceOnline ? 'online' : 'offline');
        }

        function formatNetworkNumber(num) {
            if (num >= 1000000000000) {
                return (num / 1000000000000).toFixed(2) + 'T';
            } else if (num >= 1000000000) {
                return (num / 1000000000).toFixed(2) + 'B';
            } else if (num >= 1000000) {
                return (num / 1000000).toFixed(2) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(2) + 'K';
            }
            return num.toLocaleString();
        }

        function enableManualPrice() {
            document.getElementById('currentPrice').style.display = 'none';
            document.getElementById('manualPriceInput').style.display = 'flex';
            document.getElementById('manualPrice').focus();
        }

        function updateManualPrice() {
            const manualPrice = parseFloat(document.getElementById('manualPrice').value) || 0;
            // Update display if valid price entered
            if (manualPrice > 0) {
                currentTRXPrice = manualPrice;
                updateAdditionalInvestmentState();
            }
        }

        function confirmManualPrice() {
            const manualPrice = parseFloat(document.getElementById('manualPrice').value) || 0;
            if (manualPrice > 0) {
                currentTRXPrice = manualPrice;
                document.getElementById('currentPrice').textContent = '$' + manualPrice.toFixed(4);
                document.getElementById('currentPrice').style.display = 'block';
                document.getElementById('manualPriceInput').style.display = 'none';
                updateAdditionalInvestmentState();
            } else {
                customAlert('Please enter a valid price');
            }
        }

        function handleManualPriceEnter(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                confirmManualPrice();
            }
        }

        function analyzeStakingData(accountData, resourceData, detailedAccountData) {
            const analysis = {
                totalTRXBalance: 0,
                totalStaked: 0,
                energyStaking: {
                    amount: 0,
                    source: 'Not found'
                },
                bandwidthStaking: {
                    amount: 0,
                    source: 'Not found'
                },
                votingStaking: {
                    amount: 0,
                    votes: 0
                },
                availableEnergy: 0,
                availableBandwidth: 0,
                delegatedResources: {
                    energyIn: 0,
                    energyOut: 0,
                    bandwidthIn: 0,
                    bandwidthOut: 0
                }
            };

            console.log('Basic Account Data:', accountData);
            console.log('Resource Data:', resourceData);

            // Extract TRX balance
            if (accountData.balance) {
                analysis.totalTRXBalance = accountData.balance / 1000000; // Convert from SUN to TRX
            }

            // Extract voting information (frozen for voting)
            if (accountData.votes && accountData.votes.length > 0) {
                analysis.votingStaking.votes = accountData.votes.reduce((sum, vote) => sum + (vote.vote_count || 0), 0);
                analysis.votingStaking.amount = analysis.votingStaking.votes; // In TRON, 1 vote = 1 TRX frozen
            }

            // Extract energy staking from account_resource
            if (accountData.account_resource && accountData.account_resource.frozen_balance_for_energy) {
                analysis.energyStaking.amount = accountData.account_resource.frozen_balance_for_energy.frozen_balance / 1000000;
                analysis.energyStaking.source = 'account_resource.frozen_balance_for_energy';
            }

            // Extract bandwidth staking from frozen array
            if (accountData.frozen && accountData.frozen.length > 0) {
                const bandwidthFrozen = accountData.frozen.find(f => f.frozen_balance);
                if (bandwidthFrozen) {
                    analysis.bandwidthStaking.amount = bandwidthFrozen.frozen_balance / 1000000;
                    analysis.bandwidthStaking.source = 'frozen[0].frozen_balance';
                }
            }

            // Extract current available resources (these are the energy/bandwidth UNITS you see on TronScan)
            if (resourceData.EnergyLimit) {
                analysis.availableEnergy = resourceData.EnergyLimit;
            }
            if (resourceData.NetLimit) {
                analysis.availableBandwidth = resourceData.NetLimit;
            }

            // Extract delegated resources (TRX amounts delegated TO you)
            if (resourceData.delegated_frozenV2_balance_for_energy) {
                analysis.delegatedResources.energyIn = resourceData.delegated_frozenV2_balance_for_energy / 1000000;
            }
            if (resourceData.acquire_delegated_frozenV2_balance_for_energy) {
                analysis.delegatedResources.energyOut = resourceData.acquire_delegated_frozenV2_balance_for_energy / 1000000;
            }

            // Calculate total staked (only your own staking, not delegated)
            analysis.totalStaked = analysis.energyStaking.amount + analysis.bandwidthStaking.amount + analysis.votingStaking.amount;

            console.log('Final Analysis:', analysis);

            return analysis;
        }

        async function fetchTRXData() {
            const address = document.getElementById('trxAddress').value.trim();
            
            if (!address) {
                customAlert('Please enter a TRX address');
                return;
            }
            
            if (!address.startsWith('T') || address.length !== 34) {
                customAlert('Please enter a valid TRX address (should start with T and be 34 characters long)');
                return;
            }
            
            // Show loading state
            const fetchButton = document.getElementById('fetchDataBtn');
            const originalText = fetchButton.textContent;
            fetchButton.textContent = 'Fetching...';
            fetchButton.disabled = true;
            
            try {
                // Fetch multiple types of data for the address including detailed staking info
                const [accountInfo, accountResources, accountTransactions, detailedAccount] = await Promise.all([
                    // Basic account information
                    fetch('https://api.trongrid.io/wallet/getaccount', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            address: address,
                            visible: true
                        })
                    }),
                    
                    // Account resources (energy, bandwidth, etc.)
                    fetch('https://api.trongrid.io/wallet/getaccountresource', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            address: address,
                            visible: true
                        })
                    }),
                    
                    // Recent transactions
                    fetch(`https://api.trongrid.io/v1/accounts/${address}/transactions?limit=10`),
                    
                    // Detailed account information including frozen balances
                    fetch(`https://api.trongrid.io/v1/accounts/${address}`)
                ]);
                
                // Parse responses
                const accountData = await accountInfo.json();
                const resourceData = await accountResources.json();
                const transactionData = await accountTransactions.json();
                const detailedAccountData = await detailedAccount.json();
                
                // Extract both delegated and self-staked resource values
                let delegatedEnergyTRX = 0;
                let delegatedBandwidthTRX = 0;
                let selfStakedEnergyTRX = 0;
                let selfStakedBandwidthTRX = 0;
                
                // Extract delegated resources (TRX delegated TO this address)
                if (detailedAccountData && detailedAccountData.data && detailedAccountData.data.length > 0) {
                    const accountResource = detailedAccountData.data[0].account_resource || {};
                    
                    // Extract delegated energy (convert from SUN to TRX)
                    if (accountResource.delegated_frozenV2_balance_for_energy) {
                        delegatedEnergyTRX = accountResource.delegated_frozenV2_balance_for_energy / 1000000;
                    }
                    
                    // Extract delegated bandwidth (convert from SUN to TRX)
                    if (detailedAccountData.data[0].delegated_frozenV2_balance_for_bandwidth) {
                        delegatedBandwidthTRX = detailedAccountData.data[0].delegated_frozenV2_balance_for_bandwidth / 1000000;
                    }
                }
                
                // Extract delegated energy from accountInfo.account_resource (primary location)
                if (accountData.account_resource && accountData.account_resource.delegated_frozenV2_balance_for_energy) {
                    delegatedEnergyTRX = accountData.account_resource.delegated_frozenV2_balance_for_energy / 1000000;
                }
                
                // Extract self-staked resources from frozenV2 array
                console.log('Checking frozenV2 array:', accountData.frozenV2);
                if (accountData.frozenV2 && accountData.frozenV2.length > 0) {
                    accountData.frozenV2.forEach((frozen, index) => {
                        console.log(`frozenV2[${index}]:`, frozen);
                        if (frozen.type === "ENERGY" && frozen.amount) {
                            // Self-staked energy: {"type": "ENERGY", "amount": 22000000}
                            selfStakedEnergyTRX = frozen.amount / 1000000;
                            console.log('Found self-staked energy:', selfStakedEnergyTRX);
                        } else if ((!frozen.type || frozen.type === undefined) && frozen.amount) {
                            // Self-staked bandwidth: {"amount": 174341625}
                            selfStakedBandwidthTRX = frozen.amount / 1000000;
                            console.log('Found self-staked bandwidth:', selfStakedBandwidthTRX);
                        }
                    });
                }
                
                // Calculate totals
                const totalEnergyTRX = delegatedEnergyTRX + selfStakedEnergyTRX;
                const totalBandwidthTRX = delegatedBandwidthTRX + selfStakedBandwidthTRX;
                const totalTRX = totalEnergyTRX + totalBandwidthTRX;
                
                console.log('Complete staking breakdown:', {
                    delegated: { energy: delegatedEnergyTRX, bandwidth: delegatedBandwidthTRX },
                    selfStaked: { energy: selfStakedEnergyTRX, bandwidth: selfStakedBandwidthTRX },
                    totals: { energy: totalEnergyTRX, bandwidth: totalBandwidthTRX, grand: totalTRX }
                });
                
                // Auto-populate the form fields
                if (totalTRX > 0) {
                    // Set total TRX amount
                    document.getElementById('trxAmount').value = totalTRX.toFixed(6);
                    
                    // Switch to values mode for staking split
                    const stakingSplitCheckbox = document.getElementById('stakingSplitMode');
                    if (!stakingSplitCheckbox.checked) {
                        stakingSplitCheckbox.checked = true;
                        toggleStakingMode(); // This will show the values mode
                    }
                    
                    // Populate individual energy and bandwidth amounts
                    document.getElementById('energyAmount').value = totalEnergyTRX.toFixed(6);
                    document.getElementById('bandwidthAmount').value = totalBandwidthTRX.toFixed(6);
                    
                    // Trigger form updates
                    updateStakingSplit();
                    validateSplitValues();
                    updateEnergyBandwidthDisplay();
                }
                
            } catch (error) {
                console.error('Error fetching TRX data:', error);
                alert('Error fetching data: ' + error.message + '\n\nPlease check your internet connection and try again.');
            } finally {
                // Restore button state
                fetchButton.textContent = originalText;
                fetchButton.disabled = false;
            }
        }

        function openDataDisplayPage(data) {
            // Create HTML content for the new page using string concatenation
            const htmlContent = '<!DOCTYPE html>' +
                '<html lang="en">' +
                '<head>' +
                '<meta charset="UTF-8">' +
                '<meta name="viewport" content="width=device-width, initial-scale=1.0">' +
                '<title>TRX Address Data - ' + data.address + '</title>' +
                '<style>' +
                '@import url("https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap");' +
                '* { margin: 0; padding: 0; box-sizing: border-box; }' +
                'body { font-family: "JetBrains Mono", monospace; background: #000000; color: #e9f0ff; padding: 20px; line-height: 1.6; }' +
                '.container { max-width: 1200px; margin: 0 auto; }' +
                'h1 { color: #569cd6; margin-bottom: 20px; font-size: 1.5rem; }' +
                '.address-info { background: rgba(10, 10, 10, 0.8); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 15px; margin-bottom: 20px; }' +
                '.json-container { background: #0a0a0a; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 20px; overflow-x: auto; }' +
                'pre { white-space: pre-wrap; font-size: 0.85rem; color: #e9f0ff; }' +
                '.json-key { color: #569cd6; }' +
                '.json-string { color: #ce9178; }' +
                '.json-number { color: #b5cea8; }' +
                '.json-boolean { color: #569cd6; }' +
                '.json-null { color: #808080; }' +
                '.back-button { background: linear-gradient(180deg, rgba(86, 156, 214, 0.8), rgba(86, 156, 214, 0.6)); border: 1px solid rgba(86, 156, 214, 0.4); color: #e9f0ff; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-family: "JetBrains Mono", monospace; font-size: 0.85rem; margin-bottom: 20px; }' +
                '.back-button:hover { background: linear-gradient(180deg, rgba(86, 156, 214, 0.9), rgba(86, 156, 214, 0.7)); }' +
                '</style>' +
                '</head>' +
                '<body>' +
                '<div class="container">' +
                '<button class="back-button" onclick="window.close()"> Close Window</button>' +
                '<h1>TRX Address Data</h1>' +
                '<div class="address-info">' +
                '<strong>Address:</strong> ' + data.address + '<br>' +
                '<strong>Fetched At:</strong> ' + new Date(data.fetchedAt).toLocaleString() + '<br>' +
                '<strong>Data Structure:</strong> Account Info + Resources + Recent Transactions' +
                '</div>' +
                '<div class="json-container">' +
                '<pre>' + syntaxHighlightJSON(JSON.stringify(data, null, 2)) + '</pre>' +
                '</div>' +
                '</div>' +
                '</body>' +
                '</html>';
            
            // Open new window with the data
            const newWindow = window.open('', '_blank');
            newWindow.document.write(htmlContent);
            newWindow.document.close();
        }

        function syntaxHighlightJSON(json) {
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\\\u[a-zA-Z0-9]{4}|\\\\[^u]|[^\\\\"])*"(\\s*:)?|\\b(true|false|null)\\b|-?\\d+(?:\\.\\d*)?(?:[eE][+\\-]?\\d+)?)/g, function (match) {
                var cls = 'json-number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'json-key';
                    } else {
                        cls = 'json-string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'json-boolean';
                } else if (/null/.test(match)) {
                    cls = 'json-null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }

        function updateRestakeRatioDisplay() {
            const ratio = parseFloat(document.getElementById('restakeRatioSlider').value);
            // Match the current staking slider behavior exactly
            const energyPercent = 100 - ratio;
            const bandwidthPercent = ratio;
            
            document.getElementById('restakeEnergyRatio').textContent = energyPercent;
            document.getElementById('restakeBandwidthRatio').textContent = bandwidthPercent;
            
            // Update the split display elements to match current staking style
            document.getElementById('restakeEnergyPercent').textContent = energyPercent + '%';
            document.getElementById('restakeBandwidthPercent').textContent = bandwidthPercent + '%';
        }

        function updateAdditionalInvestment() {
            const amount = parseFloat(document.getElementById('investmentAmount').value) || 0;
            const frequency = parseInt(document.getElementById('investmentFrequency').value) || 0;
            // Additional validation can be added here
        }

        function updateAdditionalInvestmentState() {
            const hasTRXPrice = currentTRXPrice !== null && currentTRXPrice > 0;
            const additionalContent = document.querySelector('.additional-investment-content');
            const helpIcon = document.getElementById('additionalInvestmentHelp');
            
            if (hasTRXPrice) {
                if (additionalContent) {
                    additionalContent.classList.remove('disabled');
                }
                helpIcon.classList.remove('visible');
                helpIcon.classList.add('hidden');
            } else {
                if (additionalContent) {
                    additionalContent.classList.add('disabled');
                }
                helpIcon.classList.remove('hidden');
                helpIcon.classList.add('visible');
            }
        }

        function updateHelpIconsVisibility() {
            const trxAmount = parseFloat(document.getElementById('trxAmount').value) || 0;
            // Help icons are now part of the block titles and don't need separate visibility management
        }

        function getAdditionalInvestment(day = 0, growthParams = null, initialTRXPrice = 0) {
            const amount = parseFloat(document.getElementById('investmentAmount').value) || 0;
            const frequency = parseInt(document.getElementById('investmentFrequency').value) || 0;
            const hasTRXPrice = (initialTRXPrice || currentTRXPrice) > 0;
            
            if (!hasTRXPrice || amount <= 0 || frequency <= 0) {
                return { amountUSD: 0, amountTRX: 0, frequencyDays: 0 };
            }
            
            // Calculate TRX price for this specific day if growth is enabled
            let trxPriceToUse = initialTRXPrice || currentTRXPrice || 0;
            if (growthParams && growthParams.enabled && initialTRXPrice > 0) {
                trxPriceToUse = calculateTRXPriceAtDay(day, initialTRXPrice, growthParams);
            }
            
            return {
                amountUSD: amount,
                amountTRX: amount / trxPriceToUse,
                frequencyDays: frequency
            };
        }

        function toggleCustomDays() {
            const claimFrequency = document.getElementById('claimFrequency').value;
            const customDaysInput = document.getElementById('customDays');
            const wrapper = customDaysInput.parentElement;
            
            if (claimFrequency === 'custom') {
                customDaysInput.style.display = 'block';
                customDaysInput.value = '30'; // Default to 30 days
                wrapper.classList.remove('single-input');
            } else {
                customDaysInput.style.display = 'none';
                wrapper.classList.add('single-input');
            }
        }

        function getClaimFrequencyDays() {
            const claimFrequency = document.getElementById('claimFrequency').value;
            
            if (claimFrequency === 'custom') {
                return parseInt(document.getElementById('customDays').value) || 30;
            }
            
            return parseInt(claimFrequency);
        }

        function validateNumberInput(input) {
            // Remove any non-numeric characters except decimal point
            let value = input.value.replace(/[^0-9.]/g, '');
            
            // Ensure only one decimal point
            const parts = value.split('.');
            if (parts.length > 2) {
                value = parts[0] + '.' + parts.slice(1).join('');
            }
            
            input.value = value;
        }


        function updateStakingSplit() {
            const trxAmount = parseFloat(document.getElementById('trxAmount').value) || 0;
            const stakingContents = document.querySelectorAll('.staking-content');
            
            if (trxAmount === 0) {
                stakingContents.forEach(content => content.classList.add('disabled'));
            } else {
                stakingContents.forEach(content => content.classList.remove('disabled'));
                // Update ratio display if in ratio mode
                if (!document.getElementById('stakingSplitMode').checked) {
                    updateRatioDisplay();
                }
            }
            
            updateHelpIconsVisibility();
        }

        function toggleStakingMode() {
            const isValuesMode = document.getElementById('stakingSplitMode').checked;
            const ratioMode = document.getElementById('ratioMode');
            const valuesMode = document.getElementById('valuesMode');
            
            if (isValuesMode) {
                ratioMode.style.display = 'none';
                valuesMode.style.display = 'block';
                // Initialize values based on current ratio (reversed logic)
                const trxAmount = parseFloat(document.getElementById('trxAmount').value) || 0;
                const ratio = parseFloat(document.getElementById('ratioSlider').value) / 100;
                document.getElementById('energyAmount').value = (trxAmount * (1 - ratio)).toFixed(2);
                document.getElementById('bandwidthAmount').value = (trxAmount * ratio).toFixed(2);
            } else {
                ratioMode.style.display = 'block';
                valuesMode.style.display = 'none';
                updateRatioDisplay();
            }
        }

        function updateRatioDisplay() {
            const ratio = parseFloat(document.getElementById('ratioSlider').value);
            const trxAmount = parseFloat(document.getElementById('trxAmount').value) || 0;
            
            // Update percentage display (reverse the logic so left = more energy)
            const energyPercent = 100 - ratio;
            const bandwidthPercent = ratio;
            
            document.getElementById('energyRatio').textContent = energyPercent;
            document.getElementById('bandwidthRatio').textContent = bandwidthPercent;
            
            // Update TRX amounts
            const energyTrx = (trxAmount * energyPercent / 100).toFixed(2);
            const bandwidthTrx = (trxAmount * bandwidthPercent / 100).toFixed(2);
            
            document.getElementById('energyTrx').textContent = energyTrx;
            document.getElementById('bandwidthTrx').textContent = bandwidthTrx;
            
            // Update energy and bandwidth availability
            updateEnergyBandwidthDisplay();
        }

        function validateSplitValues() {
            const trxAmount = parseFloat(document.getElementById('trxAmount').value) || 0;
            const energyAmount = parseFloat(document.getElementById('energyAmount').value) || 0;
            const bandwidthAmount = parseFloat(document.getElementById('bandwidthAmount').value) || 0;
            const total = energyAmount + bandwidthAmount;
            
            const validationMessage = document.getElementById('splitValidation');
            
            if (Math.abs(total - trxAmount) > 0.01 && trxAmount > 0) {
                validationMessage.style.display = 'block';
                validationMessage.textContent = `Total (${total.toFixed(2)}) must equal current amount (${trxAmount.toFixed(2)})`;
                return false;
            } else {
                validationMessage.style.display = 'none';
                return true;
            }
        }

        function autoCalculateSplit(changedInput, type) {
            const trxAmount = parseFloat(document.getElementById('trxAmount').value) || 0;
            const changedValue = parseFloat(changedInput.value) || 0;
            
            if (trxAmount > 0) {
                const remaining = Math.max(0, trxAmount - changedValue);
                
                if (type === 'energy') {
                    // User changed energy, auto-calculate bandwidth
                    const bandwidthInput = document.getElementById('bandwidthAmount');
                    bandwidthInput.value = remaining.toFixed(2);
                } else if (type === 'bandwidth') {
                    // User changed bandwidth, auto-calculate energy
                    const energyInput = document.getElementById('energyAmount');
                    energyInput.value = remaining.toFixed(2);
                }
                
                // Validate after auto-calculation
                validateSplitValues();
                
                // Update energy/bandwidth display
                updateEnergyBandwidthDisplay();
            }
        }

        function toggleLendingMode() {
            const isLendingEnabled = document.getElementById('lendingMode').checked;
            const lendingInputsContainer = document.getElementById('lendingInputsContainer');
            
            console.log('Toggling lending mode:', isLendingEnabled);
            
            if (isLendingEnabled) {
                lendingInputsContainer.classList.remove('disabled');
            } else {
                lendingInputsContainer.classList.add('disabled');
            }
        }

        function toggleGrowthMode() {
            const isGrowthEnabled = document.getElementById('growthMode').checked;
            const growthInputsContainer = document.getElementById('growthInputsContainer');
            
            if (isGrowthEnabled) {
                growthInputsContainer.classList.remove('disabled');
            } else {
                growthInputsContainer.classList.add('disabled');
            }
        }

        function getGrowthParameters() {
            const isGrowthEnabled = document.getElementById('growthMode').checked;
            
            if (!isGrowthEnabled) {
                return { enabled: false, rate: 0, periodDays: 0 };
            }
            
            const growthRate = parseFloat(document.getElementById('growthRate').value) || 0;
            const growthPeriodDays = parseInt(document.getElementById('growthPeriod').value) || 0;
            
            return {
                enabled: true,
                rate: growthRate / 100, // Convert percentage to decimal
                periodDays: growthPeriodDays
            };
        }
        
        function calculateTRXPriceAtDay(day, initialPrice, growthParams) {
            if (!growthParams.enabled || growthParams.rate === 0 || growthParams.periodDays === 0) {
                return initialPrice;
            }
            
            // Calculate daily growth rate from the period rate
            // If rate is 5% annually (365 days), daily rate = (1.05)^(1/365) - 1
            const dailyGrowthRate = Math.pow(1 + growthParams.rate, 1 / growthParams.periodDays) - 1;
            
            // Apply smooth daily compound growth: Price = InitialPrice  (1 + dailyRate)^days
            return initialPrice * Math.pow(1 + dailyGrowthRate, day);
        }

        function getStakingSplit() {
            const isValuesMode = document.getElementById('stakingSplitMode').checked;
            const trxAmount = parseFloat(document.getElementById('trxAmount').value) || 0;
            
            if (trxAmount === 0) {
                return { energy: 0, bandwidth: 0 };
            }
            
            if (isValuesMode) {
                // Values mode - get manual inputs
                return {
                    energy: parseFloat(document.getElementById('energyAmount').value) || 0,
                    bandwidth: parseFloat(document.getElementById('bandwidthAmount').value) || 0
                };
            } else {
                // Ratio mode - calculate from slider (reversed so left = more energy)
                const ratio = parseFloat(document.getElementById('ratioSlider').value) / 100;
                return {
                    energy: trxAmount * (1 - ratio),
                    bandwidth: trxAmount * ratio
                };
            }
        }

        function getRestakeSplit() {
            // Get restake split ratios from the restake slider
            const ratio = parseFloat(document.getElementById('restakeRatioSlider').value) / 100;
            return {
                energyRatio: 1 - ratio,  // Left side = more energy (reversed like current staking)
                bandwidthRatio: ratio    // Right side = more bandwidth
            };
        }

        function calculateYield() {
            // Clear previous calculation globals
            window.finalEnergyStaked = undefined;
            window.finalBandwidthStaked = undefined;
            
            // Get input values, treating empty/invalid as 0
            const trxAmount = parseFloat(document.getElementById('trxAmount').value) || 0;
            const stakingYield = parseFloat(document.getElementById('stakingYield').value) || 0;
            const years = parseInt(document.getElementById('years').value) || 0;
            const months = parseInt(document.getElementById('months').value) || 0;
            
            // Get split configurations early in function scope
            const stakingSplit = getStakingSplit(); // Initial split for period 1 only
            const restakeSplit = getRestakeSplit(); // Split for all new TRX from rewards/lending
            
            // Get claim frequency early in function scope
            const claimDays = getClaimFrequencyDays();
            
            console.log('Basic inputs:', { trxAmount, stakingYield, years, months });
            
            // Validate TRX amount
            if (trxAmount <= 0) {
                customAlert('Please enter a valid TRX amount');
                return;
            }
            
            // Validate staking split if in values mode
            const isValuesMode = document.getElementById('stakingSplitMode').checked;
            if (isValuesMode && !validateSplitValues()) {
                customAlert('Energy and Bandwidth amounts must equal the total TRX amount');
                return;
            }
            
            // Get additional investment parameters
            const additionalInvestment = getAdditionalInvestment();
            
            // Get growth parameters and initial TRX price
            const growthParams = getGrowthParameters();
            const initialTRXPrice = currentTRXPrice || 0;
            
            console.log('Growth parameters:', growthParams);
            console.log('Initial TRX price:', initialTRXPrice);
            
            // Get lending parameters - MOVED TO TOP
            const lendingEnabled = document.getElementById('lendingMode').checked;
            
            // Get lending rates - frequencies use same as claimFrequency
            let energyLendingRate = parseFloat(document.getElementById('energyLendingRate').value) || 0;
            let bandwidthLendingRate = parseFloat(document.getElementById('bandwidthLendingRate').value) || 0;
            
            
            // Handle edge cases: if time is 0, show current amount only
            if (years === 0 && months === 0) {
                let totalWithInvestments = trxAmount;
                if (additionalInvestment.frequencyDays > 0 && additionalInvestment.amountTRX > 0) {
                    // Add all investments without compounding since no time
                    totalWithInvestments += additionalInvestment.amountTRX;
                }
                updateResults(trxAmount, totalWithInvestments - trxAmount, totalWithInvestments, 0, totalWithInvestments, 0, 0, 0, 0, 0, 0);
                return;
            }
            
            // Special case: if staking yield is 0 but we have time, still simulate lending income compounding
            if (stakingYield === 0) {
                let totalLendingIncome = 0;
                let totalEnergyIncome = 0;
                let totalBandwidthIncome = 0;
                const totalDays = years * 365 + months * 30;
                
                // Calculate lending income with proper reinvestment simulation even at 0% staking
                if (lendingEnabled && (energyLendingRate > 0 || bandwidthLendingRate > 0)) {
                    // Get network parameters
                    const energyPerStakedTRX = parseFormattedNumber(document.getElementById('energyPerStakedTRX').textContent);
                    const bandwidthPerStakedTRX = parseFormattedNumber(document.getElementById('bandwidthPerStakedTRX').textContent);
                    
                    // Track energy and bandwidth amounts separately - start with initial split
                    let currentEnergyStaked = stakingSplit.energy;
                    let currentBandwidthStaked = stakingSplit.bandwidth;
                    let stakingPrincipal = trxAmount;
                    
                    // Setup simulation variables
                    let totalAdditionalInvestment = 0;
                    let nextInvestmentDay = additionalInvestment.frequencyDays;
                    let nextPayoutDay = claimDays;
                    let accumulatedEnergyIncome = 0;
                    let accumulatedBandwidthIncome = 0;
                    
                    // Daily simulation for lending income compounding
                    for (let day = 1; day <= totalDays; day++) {
                        // Calculate daily lending income based on current stakes
                        const currentEnergyUnits = energyPerStakedTRX > 0 ? currentEnergyStaked * energyPerStakedTRX : 0;
                        const currentBandwidthUnits = bandwidthPerStakedTRX > 0 ? currentBandwidthStaked * bandwidthPerStakedTRX : 0;
                        
                        const dailyEnergyIncome = (currentEnergyUnits * energyLendingRate) / 1000000;
                        const dailyBandwidthIncome = (currentBandwidthUnits * bandwidthLendingRate) / 1000000;
                        
                        accumulatedEnergyIncome += dailyEnergyIncome;
                        accumulatedBandwidthIncome += dailyBandwidthIncome;
                        
                        // Payout day - reinvest lending income using restake split
                        if (day === nextPayoutDay) {
                            totalLendingIncome += accumulatedEnergyIncome + accumulatedBandwidthIncome;
                            totalEnergyIncome += accumulatedEnergyIncome;
                            totalBandwidthIncome += accumulatedBandwidthIncome;
                            
                            // Reinvest lending income using restake split ratios
                            const totalLendingPayout = accumulatedEnergyIncome + accumulatedBandwidthIncome;
                            const lendingEnergyReinvest = totalLendingPayout * restakeSplit.energyRatio;
                            const lendingBandwidthReinvest = totalLendingPayout * restakeSplit.bandwidthRatio;
                            
                            currentEnergyStaked += lendingEnergyReinvest;
                            currentBandwidthStaked += lendingBandwidthReinvest;
                            stakingPrincipal += totalLendingPayout;
                            
                            accumulatedEnergyIncome = 0;
                            accumulatedBandwidthIncome = 0;
                            nextPayoutDay += claimDays;
                        }
                        
                        // Additional investment day - calculate using day-specific TRX price for growth
                        if (additionalInvestment.frequencyDays > 0 && day === nextInvestmentDay &&
                            totalAdditionalInvestment < additionalInvestment.amountTRX * Math.floor(totalDays / additionalInvestment.frequencyDays)) {
                            
                            // Get additional investment with growth-adjusted price for this day
                            const dailyInvestment = getAdditionalInvestment(day, growthParams, initialTRXPrice);
                            const additionalEnergyStake = dailyInvestment.amountTRX * restakeSplit.energyRatio;
                            const additionalBandwidthStake = dailyInvestment.amountTRX * restakeSplit.bandwidthRatio;
                            
                            currentEnergyStaked += additionalEnergyStake;
                            currentBandwidthStaked += additionalBandwidthStake;
                            stakingPrincipal += dailyInvestment.amountTRX;
                            totalAdditionalInvestment += dailyInvestment.amountTRX;
                            nextInvestmentDay += additionalInvestment.frequencyDays;
                        }
                    }
                    
                    // Add any remaining accumulated lending income
                    totalLendingIncome += accumulatedEnergyIncome + accumulatedBandwidthIncome;
                    totalEnergyIncome += accumulatedEnergyIncome;
                    totalBandwidthIncome += accumulatedBandwidthIncome;
                    
                    // Store final energy/bandwidth amounts for display
                    window.finalEnergyStaked = currentEnergyStaked;
                    window.finalBandwidthStaked = currentBandwidthStaked;
                } else {
                    // No lending enabled - handle additional investments only with growth-adjusted pricing
                    let totalAdditional = 0;
                    if (additionalInvestment.frequencyDays > 0 && additionalInvestment.amountTRX > 0) {
                        const totalInvestmentPeriods = Math.max(1, Math.floor(totalDays / additionalInvestment.frequencyDays));
                        
                        // Simulate day-by-day for growth-adjusted pricing
                        let nextInvestmentDay = additionalInvestment.frequencyDays;
                        let investmentCount = 0;
                        
                        for (let day = 1; day <= totalDays && investmentCount < totalInvestmentPeriods; day++) {
                            if (day === nextInvestmentDay) {
                                const dailyInvestment = getAdditionalInvestment(day, growthParams, initialTRXPrice);
                                totalAdditional += dailyInvestment.amountTRX;
                                investmentCount++;
                                nextInvestmentDay += additionalInvestment.frequencyDays;
                            }
                        }
                        
                        // Update final stakes with additional investments using restake split
                        const additionalEnergyStake = totalAdditional * restakeSplit.energyRatio;
                        const additionalBandwidthStake = totalAdditional * restakeSplit.bandwidthRatio;
                        
                        window.finalEnergyStaked = stakingSplit.energy + additionalEnergyStake;
                        window.finalBandwidthStaked = stakingSplit.bandwidth + additionalBandwidthStake;
                    } else {
                        // No additional investments - keep initial split
                        window.finalEnergyStaked = stakingSplit.energy;
                        window.finalBandwidthStaked = stakingSplit.bandwidth;
                    }
                }
                
                const totalWithInvestments = trxAmount + totalAdditional;
                const finalTotal = totalWithInvestments + totalLendingIncome;
                
                // Calculate APYs for zero staking yield scenario
                const lendingAPY = totalDays > 0 ? (totalLendingIncome / trxAmount) * (365 / totalDays) * 100 : 0;
                const combinedAPY = lendingAPY; // When staking yield is 0, combined APY = lending APY
                
                updateResults(trxAmount, totalAdditional, totalWithInvestments, 0, finalTotal, combinedAPY, totalLendingIncome, 0, lendingAPY, totalEnergyIncome, totalBandwidthIncome, growthParams, initialTRXPrice, totalDays);
                return;
            }
            
            // Calculate total time in years
            const totalYears = years + (months / 12);
            const totalDays = years * 365 + months * 30;
            
            // claimDays already declared at top of function
            
            // Calculate compound interest with additional investments and lending
            const r = stakingYield / 100; // Convert percentage to decimal
            // Use proper compounding frequency for consistency
            let n;
            if (claimDays === 1) n = 365; // Daily
            else if (claimDays === 7) n = 52; // Weekly
            else if (claimDays === 30) n = 12; // Monthly
            else if (claimDays === 90) n = 4; // Quarterly
            else n = 365 / claimDays; // Custom frequency
            const t = totalYears;
            
            console.log('Compounding frequency (n):', n, 'for claimDays:', claimDays);
            
            let totalAmount = trxAmount;
            let totalAdditionalInvestment = 0;
            let totalLendingIncome = 0;
            let totalEnergyIncome = 0;
            let totalBandwidthIncome = 0;
            let stakingPrincipal = trxAmount; // Initialize staking principal
            
            // Store period-by-period breakdown for modal - clear previous calculations
            window.calculationBreakdown = [];
            
            // Lending rates already declared above - removing duplicate declarations
            
            // Calculate actual energy and bandwidth units available
            let energyUnitsAvailable = 0;
            let bandwidthUnitsAvailable = 0;
            
            // Get network parameters to calculate actual units
            const energyPerStakedTRX = parseFormattedNumber(document.getElementById('energyPerStakedTRX').textContent);
            const bandwidthPerStakedTRX = parseFormattedNumber(document.getElementById('bandwidthPerStakedTRX').textContent);
            
            console.log('Network parameters loaded:', { energyPerStakedTRX, bandwidthPerStakedTRX });
            console.log('Staking split:', stakingSplit);
            console.log('Lending enabled:', lendingEnabled);
            console.log('Lending rates:', { energyLendingRate, bandwidthLendingRate });
            
            if (energyPerStakedTRX > 0) {
                energyUnitsAvailable = stakingSplit.energy * energyPerStakedTRX;
            }
            
            if (bandwidthPerStakedTRX > 0) {
                bandwidthUnitsAvailable = stakingSplit.bandwidth * bandwidthPerStakedTRX;
            }
            
            console.log('Energy/Bandwidth units:', { energyUnitsAvailable, bandwidthUnitsAvailable });
            
            
            // Daily lending income will be calculated dynamically based on current principal each period
            const totalDailyLendingIncome = lendingEnabled ? ((energyUnitsAvailable * energyLendingRate) + (bandwidthUnitsAvailable * bandwidthLendingRate)) / 1000000 : 0;
            
            
            if (additionalInvestment.frequencyDays > 0 && additionalInvestment.amountTRX > 0) {
                // Calculate with periodic additional investments and lending
                const totalInvestmentPeriods = Math.max(1, Math.floor(totalDays / additionalInvestment.frequencyDays));
                
                // Use daily simulation - simplified with single frequency
                stakingPrincipal = trxAmount; // Use function-scope variable
                let accumulatedStakingRewards = 0; // Track actual staking rewards earned
                let reinvestedLendingIncome = 0; // Track reinvested lending income
                let nextInvestmentDay = additionalInvestment.frequencyDays;
                let nextPayoutDay = claimDays; // Single frequency for both staking and lending
                let periodNumber = 1;
                
                // Track energy and bandwidth amounts separately - declare here for this code path
                let currentEnergyStaked = stakingSplit.energy;
                let currentBandwidthStaked = stakingSplit.bandwidth;
                
                // Accumulate lending income between payouts
                let accumulatedEnergyIncome = 0;
                let accumulatedBandwidthIncome = 0;
                
                for (let day = 1; day <= totalDays; day++) {
                    // Calculate lending income based on current staking principal
                    if (lendingEnabled) {
                        // Use actual tracked energy/bandwidth stakes (updated with restake split)
                        const currentEnergyUnits = energyPerStakedTRX > 0 ? currentEnergyStaked * energyPerStakedTRX : 0;
                        const currentBandwidthUnits = bandwidthPerStakedTRX > 0 ? currentBandwidthStaked * bandwidthPerStakedTRX : 0;
                        
                        const dailyEnergyIncome = (currentEnergyUnits * energyLendingRate) / 1000000;
                        const dailyBandwidthIncome = (currentBandwidthUnits * bandwidthLendingRate) / 1000000;
                        
                        accumulatedEnergyIncome += dailyEnergyIncome;
                        accumulatedBandwidthIncome += dailyBandwidthIncome;
                    }
                    
                    // Combined payout and staking day - single frequency
                    if (day === nextPayoutDay) {
                        const initialAmountThisPeriod = stakingPrincipal;
                        let energyIncomeThisPeriod = accumulatedEnergyIncome;
                        let bandwidthIncomeThisPeriod = accumulatedBandwidthIncome;
                        
                        // Process lending payouts and reinvest immediately
                        if (lendingEnabled) {
                            totalLendingIncome += accumulatedEnergyIncome + accumulatedBandwidthIncome;
                            totalEnergyIncome += accumulatedEnergyIncome;
                            totalBandwidthIncome += accumulatedBandwidthIncome;
                            
                            // Reinvest lending income using restake split ratios
                            const totalLendingPayout = accumulatedEnergyIncome + accumulatedBandwidthIncome;
                            const lendingEnergyReinvest = totalLendingPayout * restakeSplit.energyRatio;
                            const lendingBandwidthReinvest = totalLendingPayout * restakeSplit.bandwidthRatio;
                            
                            currentEnergyStaked += lendingEnergyReinvest;
                            currentBandwidthStaked += lendingBandwidthReinvest;
                            stakingPrincipal += totalLendingPayout;
                            reinvestedLendingIncome += totalLendingPayout;
                            
                            accumulatedEnergyIncome = 0;
                            accumulatedBandwidthIncome = 0;
                        }
                        
                        // Process staking rewards and reinvest using restake split ratios
                        const stakingReward = stakingPrincipal * (r / n);
                        const rewardEnergyReinvest = stakingReward * restakeSplit.energyRatio;
                        const rewardBandwidthReinvest = stakingReward * restakeSplit.bandwidthRatio;
                        
                        currentEnergyStaked += rewardEnergyReinvest;
                        currentBandwidthStaked += rewardBandwidthReinvest;
                        stakingPrincipal += stakingReward;
                        accumulatedStakingRewards += stakingReward;
                        
                        // Store period breakdown
                        window.calculationBreakdown.push({
                            period: periodNumber,
                            initialAmount: initialAmountThisPeriod,
                            stakingReward: stakingReward,
                            energyIncome: energyIncomeThisPeriod,
                            bandwidthIncome: bandwidthIncomeThisPeriod,
                            finalAmount: stakingPrincipal
                        });
                        
                        periodNumber++;
                        nextPayoutDay += claimDays;
                    }
                    
                    // Additional investment day - calculate using day-specific TRX price for growth
                    if (day === nextInvestmentDay && totalAdditionalInvestment < additionalInvestment.amountTRX * totalInvestmentPeriods) {
                        // Get additional investment with growth-adjusted price for this day
                        const dailyInvestment = getAdditionalInvestment(day, growthParams, initialTRXPrice);
                        const additionalEnergyStake = dailyInvestment.amountTRX * restakeSplit.energyRatio;
                        const additionalBandwidthStake = dailyInvestment.amountTRX * restakeSplit.bandwidthRatio;
                        
                        currentEnergyStaked += additionalEnergyStake;
                        currentBandwidthStaked += additionalBandwidthStake;
                        stakingPrincipal += dailyInvestment.amountTRX;
                        totalAdditionalInvestment += dailyInvestment.amountTRX;
                        nextInvestmentDay += additionalInvestment.frequencyDays;
                    }
                }
                
                // Add any remaining accumulated lending income
                totalLendingIncome += accumulatedEnergyIncome + accumulatedBandwidthIncome;
                totalEnergyIncome += accumulatedEnergyIncome;
                totalBandwidthIncome += accumulatedBandwidthIncome;
                
                // Store final energy/bandwidth amounts for display
                window.finalEnergyStaked = currentEnergyStaked;
                window.finalBandwidthStaked = currentBandwidthStaked;
                
                // Total amount = staking principal + non-reinvested lending income
                totalAmount = stakingPrincipal + (totalLendingIncome - reinvestedLendingIncome);
                
            } else {
                // Standard compound interest with lending but no additional investments
                if (lendingEnabled && totalDailyLendingIncome > 0) {
                    // Use daily simulation - simplified with single frequency
                    stakingPrincipal = trxAmount; // Use function-scope variable
                    let accumulatedStakingRewards = 0; // Track actual staking rewards earned
                    let reinvestedLendingIncome = 0; // Track reinvested lending income separately
                    let nextPayoutDay = claimDays; // Single frequency
                    let periodNumber = 1;
                    
                    // Track energy and bandwidth amounts separately
                    let currentEnergyStaked = stakingSplit.energy; // Initial split for period 1
                    let currentBandwidthStaked = stakingSplit.bandwidth;
                    
                    let accumulatedEnergyIncome = 0;
                    let accumulatedBandwidthIncome = 0;
                    
                    for (let day = 1; day <= totalDays; day++) {
                        // Calculate lending income based on current energy/bandwidth stakes
                        if (lendingEnabled && (energyLendingRate > 0 || bandwidthLendingRate > 0)) {
                            const currentEnergyUnits = energyPerStakedTRX > 0 ? currentEnergyStaked * energyPerStakedTRX : 0;
                            const currentBandwidthUnits = bandwidthPerStakedTRX > 0 ? currentBandwidthStaked * bandwidthPerStakedTRX : 0;
                            
                            const dailyEnergyIncome = (currentEnergyUnits * energyLendingRate) / 1000000;
                            const dailyBandwidthIncome = (currentBandwidthUnits * bandwidthLendingRate) / 1000000;
                            
                            accumulatedEnergyIncome += dailyEnergyIncome;
                            accumulatedBandwidthIncome += dailyBandwidthIncome;
                        }
                        
                        // Combined payout and staking day
                        if (day === nextPayoutDay) {
                            const initialAmountThisPeriod = stakingPrincipal;
                            let energyIncomeThisPeriod = accumulatedEnergyIncome;
                            let bandwidthIncomeThisPeriod = accumulatedBandwidthIncome;
                            
                            // Process lending payouts and reinvest using restake split
                            if (lendingEnabled) {
                                totalLendingIncome += accumulatedEnergyIncome + accumulatedBandwidthIncome;
                                totalEnergyIncome += accumulatedEnergyIncome;
                                totalBandwidthIncome += accumulatedBandwidthIncome;
                                
                                // Reinvest lending income using restake split ratios
                                const totalLendingPayout = accumulatedEnergyIncome + accumulatedBandwidthIncome;
                                const lendingEnergyReinvest = totalLendingPayout * restakeSplit.energyRatio;
                                const lendingBandwidthReinvest = totalLendingPayout * restakeSplit.bandwidthRatio;
                                
                                currentEnergyStaked += lendingEnergyReinvest;
                                currentBandwidthStaked += lendingBandwidthReinvest;
                                stakingPrincipal += totalLendingPayout;
                                reinvestedLendingIncome += totalLendingPayout;
                                
                                accumulatedEnergyIncome = 0;
                                accumulatedBandwidthIncome = 0;
                            }
                            
                            // Process staking rewards and reinvest using restake split
                            const stakingReward = stakingPrincipal * (r / n);
                            const rewardEnergyReinvest = stakingReward * restakeSplit.energyRatio;
                            const rewardBandwidthReinvest = stakingReward * restakeSplit.bandwidthRatio;
                            
                            currentEnergyStaked += rewardEnergyReinvest;
                            currentBandwidthStaked += rewardBandwidthReinvest;
                            stakingPrincipal += stakingReward;
                            accumulatedStakingRewards += stakingReward;
                            
                            // Store period breakdown
                            window.calculationBreakdown.push({
                                period: periodNumber,
                                initialAmount: initialAmountThisPeriod,
                                stakingReward: stakingReward,
                                energyIncome: energyIncomeThisPeriod,
                                bandwidthIncome: bandwidthIncomeThisPeriod,
                                finalAmount: stakingPrincipal
                            });
                            
                            periodNumber++;
                            nextPayoutDay += claimDays;
                        }
                    }
                    
                    // Add any remaining accumulated lending income
                    totalLendingIncome += accumulatedEnergyIncome + accumulatedBandwidthIncome;
                    totalEnergyIncome += accumulatedEnergyIncome;
                    totalBandwidthIncome += accumulatedBandwidthIncome;
                    
                    // Store final energy/bandwidth amounts for display
                    window.finalEnergyStaked = currentEnergyStaked;
                    window.finalBandwidthStaked = currentBandwidthStaked;
                    
                    // Total amount = staking principal + non-reinvested lending income
                    totalAmount = stakingPrincipal + (totalLendingIncome - reinvestedLendingIncome);
                    
                } else {
                    // No lending - simulate period-by-period to apply restake split correctly
                    stakingPrincipal = trxAmount;
                    let currentEnergyStaked = stakingSplit.energy; // Initial split for period 1 only
                    let currentBandwidthStaked = stakingSplit.bandwidth;
                    let totalAdditionalInvestment = 0;
                    let nextInvestmentDay = additionalInvestment.frequencyDays;
                    let nextPayoutDay = claimDays;
                    
                    // Simulate day by day to properly apply restake split from period 1 onwards
                    for (let day = 1; day <= totalDays; day++) {
                        // Staking payout day - apply restake split to rewards
                        if (day === nextPayoutDay) {
                            const stakingReward = stakingPrincipal * (r / n);
                            const rewardEnergyPortion = stakingReward * restakeSplit.energyRatio;
                            const rewardBandwidthPortion = stakingReward * restakeSplit.bandwidthRatio;
                            
                            currentEnergyStaked += rewardEnergyPortion;
                            currentBandwidthStaked += rewardBandwidthPortion;
                            stakingPrincipal += stakingReward;
                            
                            nextPayoutDay += claimDays;
                        }
                        
                        // Additional investment day - calculate using day-specific TRX price for growth
                        if (additionalInvestment.frequencyDays > 0 && day === nextInvestmentDay &&
                            totalAdditionalInvestment < additionalInvestment.amountTRX * Math.floor(totalDays / additionalInvestment.frequencyDays)) {
                            
                            // Get additional investment with growth-adjusted price for this day
                            const dailyInvestment = getAdditionalInvestment(day, growthParams, initialTRXPrice);
                            const additionalEnergyStake = dailyInvestment.amountTRX * restakeSplit.energyRatio;
                            const additionalBandwidthStake = dailyInvestment.amountTRX * restakeSplit.bandwidthRatio;
                            
                            currentEnergyStaked += additionalEnergyStake;
                            currentBandwidthStaked += additionalBandwidthStake;
                            stakingPrincipal += dailyInvestment.amountTRX;
                            totalAdditionalInvestment += dailyInvestment.amountTRX;
                            nextInvestmentDay += additionalInvestment.frequencyDays;
                        }
                    }
                    
                    totalAmount = stakingPrincipal;
                    window.finalEnergyStaked = currentEnergyStaked;
                    window.finalBandwidthStaked = currentBandwidthStaked;
                    
                    console.log('No lending simulation completed - stakingPrincipal:', stakingPrincipal);
                    console.log('Final splits:', { energy: currentEnergyStaked, bandwidth: currentBandwidthStaked });
                }
            }
            
            console.log('Before stakingRewards calculation:', {
                stakingPrincipal,
                trxAmount,
                totalAdditionalInvestment,
                lendingPath: lendingEnabled && totalDailyLendingIncome > 0
            });
            
            // Calculate pure staking rewards - only rewards on original investment + additional investments
            // When lending income is reinvested, rewards on that reinvested amount are lending benefits, not staking rewards
            let stakingRewards;
            if (lendingEnabled && totalDailyLendingIncome > 0) {
                // Calculate what staking rewards would be WITHOUT any reinvestment
                const baseAmount = trxAmount + totalAdditionalInvestment;
                const expectedStakingAmount = baseAmount * Math.pow((1 + r / n), (n * t));
                stakingRewards = expectedStakingAmount - baseAmount;
                console.log('Pure staking calculation - base:', baseAmount, 'expected:', expectedStakingAmount, 'rewards:', stakingRewards);
            } else {
                // No lending - standard calculation
                stakingRewards = stakingPrincipal - trxAmount - totalAdditionalInvestment;
            }
            
            // Ensure breakdown exists even if no lending
            if (!window.calculationBreakdown || window.calculationBreakdown.length === 0) {
                // Create simple breakdown for non-lending case
                const periods = Math.ceil(totalDays / claimDays);
                let currentPrincipal = trxAmount;
                window.calculationBreakdown = [];
                
                for (let period = 1; period <= periods; period++) {
                    const initialAmountThisPeriod = currentPrincipal;
                    const stakingReward = currentPrincipal * (r / n);
                    currentPrincipal += stakingReward;
                    
                    window.calculationBreakdown.push({
                        period: period,
                        initialAmount: initialAmountThisPeriod,
                        stakingReward: stakingReward,
                        energyIncome: 0,
                        bandwidthIncome: 0,
                        finalAmount: currentPrincipal
                    });
                }
            }
            
            console.log('Staking rewards calculated as:', stakingRewards);
            
            console.log('Final calculation values:', {
                stakingPrincipal,
                trxAmount,
                totalAdditionalInvestment,
                stakingRewards,
                totalLendingIncome,
                totalAmount,
                stakingYield,
                r,
                n
            });
            
            // Calculate individual APYs
            const stakingAPY = stakingYield > 0 ? (Math.pow((1 + r / n), n) - 1) * 100 : 0;
            const lendingAPY = totalDays > 0 ? (totalLendingIncome / trxAmount) * (365 / totalDays) * 100 : 0;
            
            console.log('APY calculations:', { stakingAPY, lendingAPY });
            
            // Calculate combined APY - sum of individual APYs or total return method
            let combinedAPY = 0;
            if (totalDays > 0) {
                if (stakingAPY > 0 || lendingAPY > 0) {
                    // Use total return method for combined APY
                    combinedAPY = ((totalAmount - trxAmount - totalAdditionalInvestment) / trxAmount) * (365 / totalDays) * 100;
                }
            }
            
            console.log('Final APYs:', { stakingAPY, lendingAPY, combinedAPY });
            
            // Update the display - pass growth parameters and timing info for USD calculations
            updateResults(trxAmount, totalAdditionalInvestment, trxAmount + totalAdditionalInvestment, stakingRewards, totalAmount, combinedAPY, totalLendingIncome, stakingAPY, lendingAPY, totalEnergyIncome, totalBandwidthIncome, growthParams, initialTRXPrice, totalDays);
            
            // Update energy and bandwidth availability
            updateEnergyBandwidthDisplay();
        }
        
        function updateResults(initial, additionalPrincipal, invested, rewards, total, combinedApy, lendingIncome = 0, stakingApy = 0, lendingApy = 0, energyIncome = 0, bandwidthIncome = 0, growthParams = null, initialTRXPrice = 0, totalDays = 0) {
            // Calculate additional investment per period
            const additionalInvestment = getAdditionalInvestment();
            const additionalPerPeriod = additionalInvestment.amountTRX;
            
            // Update TRX amounts
            document.getElementById('initialAmount').textContent = formatNumber(initial) + ' TRX';
            document.getElementById('additionalPerPeriod').textContent = formatNumber(additionalPerPeriod) + ' TRX';
            document.getElementById('additionalPrincipal').textContent = formatNumber(additionalPrincipal) + ' TRX';
            document.getElementById('investedAmount').textContent = formatNumber(invested) + ' TRX';
            document.getElementById('stakingRewards').textContent = formatNumber(rewards) + ' TRX';
            document.getElementById('totalAmount').textContent = formatNumber(total) + ' TRX';
            document.getElementById('lendingIncome').textContent = formatNumber(lendingIncome) + ' TRX';
            document.getElementById('energyIncome').textContent = formatNumber(energyIncome) + ' TRX';
            document.getElementById('bandwidthIncome').textContent = formatNumber(bandwidthIncome) + ' TRX';
            
            // Update APY values
            document.getElementById('stakingApy').textContent = formatNumber(stakingApy, 2) + '%';
            document.getElementById('lendingApy').textContent = formatNumber(lendingApy, 2) + '%';
            document.getElementById('combinedApy').textContent = formatNumber(combinedApy, 2) + '%';
            
            // Update Growth Rate display
            let growthRateText = '0%';
            if (growthParams && growthParams.enabled && growthParams.rate > 0) {
                const ratePercent = (growthParams.rate * 100).toFixed(1);
                let periodText = '';
                
                switch (growthParams.periodDays) {
                    case 30: periodText = 'Monthly'; break;
                    case 90: periodText = 'Quarterly'; break;
                    case 180: periodText = 'Half Yearly'; break;
                    case 365: periodText = 'Yearly'; break;
                    default: periodText = `Every ${growthParams.periodDays} days`; break;
                }
                
                growthRateText = `${ratePercent}% ${periodText}`;
            }
            document.getElementById('growthRate').textContent = growthRateText;
            
            // Update final energy and bandwidth based on total amount
            updateFinalEnergyBandwidth(total);
            
            // Calculate USD values - use initial price for static values, final price for growth-affected values
            const initialPrice = initialTRXPrice || currentTRXPrice || 0;
            let finalPrice = initialPrice;
            
            // If TRX growth is enabled, calculate the final TRX price
            if (growthParams && growthParams.enabled && initialPrice > 0 && totalDays > 0) {
                finalPrice = calculateTRXPriceAtDay(totalDays, initialPrice, growthParams);
            }
            
            // Safely update USD elements with error checking
            const usdUpdates = [
                { id: 'initialAmountUSD', value: initial * initialPrice }, // Use initial price
                { id: 'additionalPerPeriodUSD', value: additionalPerPeriod * initialPrice }, // Use initial price (shows first period amount)
                { id: 'additionalPrincipalUSD', value: additionalPrincipal * initialPrice }, // Mixed - approximation using initial price
                { id: 'investedAmountUSD', value: invested * initialPrice }, // Mixed - approximation using initial price
                { id: 'stakingRewardsUSD', value: rewards * finalPrice }, // Use final price (rewards valued at end)
                { id: 'totalAmountUSD', value: total * finalPrice }, // Use final price (final value)
                { id: 'lendingIncomeUSD', value: lendingIncome * finalPrice }, // Use final price (income valued at end)
                { id: 'energyIncomeUSD', value: energyIncome * finalPrice }, // Use final price (income valued at end)
                { id: 'bandwidthIncomeUSD', value: bandwidthIncome * finalPrice } // Use final price (income valued at end)
            ];
            
            usdUpdates.forEach(update => {
                const element = document.getElementById(update.id);
                if (element) {
                    element.textContent = `($${formatNumber(update.value)})`;
                } else {
                    console.log(`USD element not found: ${update.id}`);
                }
            });
            
            // Calculate monthly staking income from final total amount
            const stakingYieldValue = parseFloat(document.getElementById('stakingYield').value) || 0;
            let monthlyStakingIncome = 0;
            
            if (stakingYieldValue > 0 && total > 0) {
                // Calculate monthly income: (Final Total  Annual Yield) / 12
                const annualStakingIncome = total * (stakingYieldValue / 100);
                monthlyStakingIncome = annualStakingIncome / 12;
            }
            
            // Update monthly staking income display
            document.getElementById('stakingIncomeMonthly').textContent = formatNumber(monthlyStakingIncome) + ' TRX';
            
            // Update USD value for monthly staking income
            const monthlyStakingIncomeUSD = monthlyStakingIncome * finalPrice;
            const monthlyIncomeUSDElement = document.getElementById('stakingIncomeMonthlyUSD');
            if (monthlyIncomeUSDElement) {
                monthlyIncomeUSDElement.textContent = `($${formatNumber(monthlyStakingIncomeUSD)})`;
            }
            
            // Calculate monthly lending income from final total amount
            let monthlyLendingIncome = 0;
            
            // Check if lending is enabled and we have final staking amounts
            const lendingEnabled = document.getElementById('lendingMode').checked;
            if (lendingEnabled && window.finalEnergyStaked !== undefined && window.finalBandwidthStaked !== undefined) {
                // Get lending rates and network parameters
                const energyLendingRate = parseFloat(document.getElementById('energyLendingRate').value) || 0;
                const bandwidthLendingRate = parseFloat(document.getElementById('bandwidthLendingRate').value) || 0;
                const energyPerStakedTRX = parseFormattedNumber(document.getElementById('energyPerStakedTRX').textContent) || 0;
                const bandwidthPerStakedTRX = parseFormattedNumber(document.getElementById('bandwidthPerStakedTRX').textContent) || 0;
                
                // Calculate daily lending income from final stakes
                if (energyPerStakedTRX > 0 || bandwidthPerStakedTRX > 0) {
                    const finalEnergyUnits = window.finalEnergyStaked * energyPerStakedTRX;
                    const finalBandwidthUnits = window.finalBandwidthStaked * bandwidthPerStakedTRX;
                    
                    const dailyEnergyIncome = (finalEnergyUnits * energyLendingRate) / 1000000;
                    const dailyBandwidthIncome = (finalBandwidthUnits * bandwidthLendingRate) / 1000000;
                    
                    // Convert to monthly (30 days)
                    monthlyLendingIncome = (dailyEnergyIncome + dailyBandwidthIncome) * 30;
                }
            }
            
            // Update monthly lending income display
            document.getElementById('lendingIncomeMonthly').textContent = formatNumber(monthlyLendingIncome) + ' TRX';
            
            // Update USD value for monthly lending income
            const monthlyLendingIncomeUSD = monthlyLendingIncome * finalPrice;
            const monthlyLendingIncomeUSDElement = document.getElementById('lendingIncomeMonthlyUSD');
            if (monthlyLendingIncomeUSDElement) {
                monthlyLendingIncomeUSDElement.textContent = `($${formatNumber(monthlyLendingIncomeUSD)})`;
            }
        }

        function updateFinalEnergyBandwidth(totalTRXAmount) {
            // Check if elements exist first to prevent errors
            const energyFinalElement = document.getElementById('energyFinal');
            const bandwidthFinalElement = document.getElementById('bandwidthFinal');
            
            if (!energyFinalElement || !bandwidthFinalElement) {
                console.log('Energy/Bandwidth Final elements not found, skipping update');
                return;
            }
            
            // Get network parameters
            let energyPerStakedTRX = 0;
            let bandwidthPerStakedTRX = 0;
            
            const energyText = document.getElementById('energyPerStakedTRX').textContent;
            const bandwidthText = document.getElementById('bandwidthPerStakedTRX').textContent;
            
            if (energyText && energyText !== 'Loading...' && energyText !== '--') {
                energyPerStakedTRX = parseFormattedNumber(energyText);
            }
            
            if (bandwidthText && bandwidthText !== 'Loading...' && bandwidthText !== '--') {
                bandwidthPerStakedTRX = parseFormattedNumber(bandwidthText);
            }
            
            // Use global variables if available from calculation, otherwise fall back to proportional
            let finalEnergyTRX, finalBandwidthTRX;
            
            if (window.finalEnergyStaked !== undefined && window.finalBandwidthStaked !== undefined) {
                // Use actual tracked values from simulation
                finalEnergyTRX = window.finalEnergyStaked;
                finalBandwidthTRX = window.finalBandwidthStaked;
            } else {
                // Fall back to proportional calculation using current split
                const stakingSplit = getStakingSplit();
                const trxAmount = parseFloat(document.getElementById('trxAmount').value) || 0;
                
                let energyRatio = 0.5; // Default 50/50
                let bandwidthRatio = 0.5;
                
                if (trxAmount > 0) {
                    energyRatio = stakingSplit.energy / trxAmount;
                    bandwidthRatio = stakingSplit.bandwidth / trxAmount;
                }
                
                finalEnergyTRX = totalTRXAmount * energyRatio;
                finalBandwidthTRX = totalTRXAmount * bandwidthRatio;
            }
            
            // Calculate final energy and bandwidth units
            let finalEnergy = 0;
            let finalBandwidth = 0;
            
            if (energyPerStakedTRX > 0) {
                finalEnergy = finalEnergyTRX * energyPerStakedTRX;
            }
            
            if (bandwidthPerStakedTRX > 0) {
                finalBandwidth = finalBandwidthTRX * bandwidthPerStakedTRX;
            }
            
            // Update display safely
            energyFinalElement.textContent = formatNetworkNumber(finalEnergy);
            bandwidthFinalElement.textContent = formatNetworkNumber(finalBandwidth);
        }

        function updateEnergyBandwidthDisplay() {
            // Get network parameters - parse the formatted numbers
            let energyPerStakedTRX = 0;
            let bandwidthPerStakedTRX = 0;
            
            const energyText = document.getElementById('energyPerStakedTRX').textContent;
            const bandwidthText = document.getElementById('bandwidthPerStakedTRX').textContent;
            
            // Parse formatted numbers (handle K, M, B, T suffixes)
            if (energyText && energyText !== 'Loading...' && energyText !== '--') {
                energyPerStakedTRX = parseFormattedNumber(energyText);
            }
            
            if (bandwidthText && bandwidthText !== 'Loading...' && bandwidthText !== '--') {
                bandwidthPerStakedTRX = parseFormattedNumber(bandwidthText);
            }
            
            // Get current staking split (this is always the initial split for display)
            const stakingSplit = getStakingSplit();
            
            // Calculate available energy and bandwidth for initial amounts
            let energyAvailable = 0;
            let bandwidthAvailable = 0;
            
            if (energyPerStakedTRX > 0 && stakingSplit.energy > 0) {
                energyAvailable = energyPerStakedTRX * stakingSplit.energy;
            }
            
            if (bandwidthPerStakedTRX > 0 && stakingSplit.bandwidth > 0) {
                bandwidthAvailable = bandwidthPerStakedTRX * stakingSplit.bandwidth;
            }
            
            // Update display - these show the initial available amounts
            document.getElementById('energyAvailable').textContent = formatNetworkNumber(energyAvailable);
            document.getElementById('bandwidthAvailable').textContent = formatNetworkNumber(bandwidthAvailable);
        }

        function parseFormattedNumber(text) {
            if (!text || text === 'Loading...' || text === '--') return 0;
            
            const num = parseFloat(text);
            if (text.includes('T')) return num * 1000000000000;
            if (text.includes('B')) return num * 1000000000;
            if (text.includes('M')) return num * 1000000;
            if (text.includes('K')) return num * 1000;
            return num;
        }
        
        function formatNumber(num, decimals = 2) {
            return num.toLocaleString('en-US', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            });
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Fetch TRX price and network stats
            getTRXPrice();
            getTRONNetworkStats();
            
            // Refresh price every 60 seconds
            setInterval(getTRXPrice, 60000);
            
            // Refresh network stats every 2 minutes
            setInterval(getTRONNetworkStats, 120000);
            
            // Initialize staking split functionality
            updateStakingSplit();
            updateRatioDisplay();
            updateRestakeRatioDisplay();
            updateAdditionalInvestmentState();
            updateHelpIconsVisibility();
            
            // Initialize lending functionality
            toggleLendingMode();
            
            // Initialize growth functionality
            toggleGrowthMode();
            
            // Initialize claim frequency layout
            toggleCustomDays();
            
            // Add enter key support
            const inputs = document.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        calculateYield();
                    }
                });
            });
        });
        
        // Modal functions
        function showCalculationsModal() {
            // Check if calculation breakdown exists
            if (!window.calculationBreakdown || window.calculationBreakdown.length === 0) {
                customAlert('Please run a calculation first to see the breakdown.');
                return;
            }
            
            generateCalculationsTable();
            document.getElementById('calculationsModal').style.display = 'block';
        }
        
        function showGraphModal() {
            // Check if calculation breakdown exists
            if (!window.calculationBreakdown || window.calculationBreakdown.length === 0) {
                customAlert('Please run a calculation first to see the graph.');
                return;
            }
            
            document.getElementById('graphModal').style.display = 'block';
            // Generate chart after modal is visible
            setTimeout(() => generateChart(), 100);
        }
        
        function closeCalculationsModal() {
            document.getElementById('calculationsModal').style.display = 'none';
        }
        
        function closeGraphModal() {
            document.getElementById('graphModal').style.display = 'none';
        }
        
        function closeModal(event) {
            if (event.target === event.currentTarget) {
                const calculationsModal = document.getElementById('calculationsModal');
                const graphModal = document.getElementById('graphModal');
                
                if (calculationsModal && calculationsModal.style.display === 'block') {
                    closeCalculationsModal();
                }
                if (graphModal && graphModal.style.display === 'block') {
                    closeGraphModal();
                }
            }
        }
        
        // Custom Modal Functions
        function showError(message) {
            document.getElementById('errorMessage').innerHTML = message;
            document.getElementById('errorModal').style.display = 'block';
        }
        
        function showSuccess(message) {
            document.getElementById('successMessage').innerHTML = message;
            document.getElementById('successModal').style.display = 'block';
        }
        
        function closeErrorModal() {
            document.getElementById('errorModal').style.display = 'none';
        }
        
        function closeSuccessModal() {
            document.getElementById('successModal').style.display = 'none';
        }
        
        // Replace browser alerts with custom modals
        function customAlert(message) {
            if (message.includes('') || message.toLowerCase().includes('success')) {
                showSuccess(' ' + message.replace(' ', ''));
            } else if (message.includes('') || message.toLowerCase().includes('error')) {
                showError(' ' + message.replace(' ', ''));
            } else {
                showError(' ' + message);
            }
        }
        
        function generateCalculationsTable() {
            const container = document.getElementById('calculationsTableContainer');
            const breakdown = window.calculationBreakdown;
            
            // Get growth parameters and pricing info for USD calculations
            const growthParams = getGrowthParameters();
            const initialTRXPrice = currentTRXPrice || 0;
            const claimDays = getClaimFrequencyDays();
            
            let tableHTML = `
                <table class="calculations-table">
                    <thead>
                        <tr>
                            <th>Period</th>
                            <th>Initial Amount</th>
                            <th>Staking Reward</th>
                            <th>Energy Income</th>
                            <th>Bandwidth Income</th>
                            <th>Final Amount</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            let totalStakingRewards = 0;
            let totalEnergyIncome = 0;
            let totalBandwidthIncome = 0;
            
            breakdown.forEach(period => {
                totalStakingRewards += period.stakingReward;
                totalEnergyIncome += period.energyIncome;
                totalBandwidthIncome += period.bandwidthIncome;
                
                // Calculate USD values for this period
                const periodDay = period.period * claimDays;
                let trxPrice = initialTRXPrice;
                if (growthParams && growthParams.enabled && initialTRXPrice > 0) {
                    trxPrice = calculateTRXPriceAtDay(periodDay, initialTRXPrice, growthParams);
                }
                
                const initialUSD = period.initialAmount * trxPrice;
                const rewardUSD = period.stakingReward * trxPrice;
                const energyUSD = period.energyIncome * trxPrice;
                const bandwidthUSD = period.bandwidthIncome * trxPrice;
                const finalUSD = period.finalAmount * trxPrice;
                
                tableHTML += `
                    <tr>
                        <td class="period-number">Period ${period.period}</td>
                        <td class="amount-value">
                            ${formatNumber(period.initialAmount)} TRX
                            <div style="font-size: 0.65rem; color: #ce9178; margin-top: 2px;">($${formatNumber(initialUSD)})</div>
                        </td>
                        <td class="amount-value">
                            ${formatNumber(period.stakingReward)} TRX
                            <div style="font-size: 0.65rem; color: #ce9178; margin-top: 2px;">($${formatNumber(rewardUSD)})</div>
                        </td>
                        <td class="amount-value">
                            ${formatNumber(period.energyIncome)} TRX
                            <div style="font-size: 0.65rem; color: #ce9178; margin-top: 2px;">($${formatNumber(energyUSD)})</div>
                        </td>
                        <td class="amount-value">
                            ${formatNumber(period.bandwidthIncome)} TRX
                            <div style="font-size: 0.65rem; color: #ce9178; margin-top: 2px;">($${formatNumber(bandwidthUSD)})</div>
                        </td>
                        <td class="amount-value">
                            ${formatNumber(period.finalAmount)} TRX
                            <div style="font-size: 0.65rem; color: #ce9178; margin-top: 2px;">($${formatNumber(finalUSD)})</div>
                        </td>
                    </tr>
                `;
            });
            
            // Add totals row
            const finalAmount = breakdown[breakdown.length - 1].finalAmount;
            const finalPeriodDay = breakdown.length * claimDays;
            let finalTRXPrice = initialTRXPrice;
            if (growthParams && growthParams.enabled && initialTRXPrice > 0) {
                finalTRXPrice = calculateTRXPriceAtDay(finalPeriodDay, initialTRXPrice, growthParams);
            }
            
            const totalRewardsUSD = totalStakingRewards * finalTRXPrice;
            const totalEnergyUSD = totalEnergyIncome * finalTRXPrice;
            const totalBandwidthUSD = totalBandwidthIncome * finalTRXPrice;
            const finalAmountUSD = finalAmount * finalTRXPrice;
            
            tableHTML += `
                    <tr class="total-row">
                        <td><strong>TOTALS</strong></td>
                        <td class="amount-value"><strong>-</strong></td>
                        <td class="amount-value">
                            <strong>${formatNumber(totalStakingRewards)} TRX</strong>
                            <div style="font-size: 0.65rem; color: #ce9178; margin-top: 2px;"><strong>($${formatNumber(totalRewardsUSD)})</strong></div>
                        </td>
                        <td class="amount-value">
                            <strong>${formatNumber(totalEnergyIncome)} TRX</strong>
                            <div style="font-size: 0.65rem; color: #ce9178; margin-top: 2px;"><strong>($${formatNumber(totalEnergyUSD)})</strong></div>
                        </td>
                        <td class="amount-value">
                            <strong>${formatNumber(totalBandwidthIncome)} TRX</strong>
                            <div style="font-size: 0.65rem; color: #ce9178; margin-top: 2px;"><strong>($${formatNumber(totalBandwidthUSD)})</strong></div>
                        </td>
                        <td class="amount-value">
                            <strong>${formatNumber(finalAmount)} TRX</strong>
                            <div style="font-size: 0.65rem; color: #ce9178; margin-top: 2px;"><strong>($${formatNumber(finalAmountUSD)})</strong></div>
                        </td>
                    </tr>
                </tbody>
            </table>
            `;
            
            container.innerHTML = tableHTML;
        }
        
        function generateChart() {
            if (!window.calculationBreakdown || window.calculationBreakdown.length === 0) {
                return;
            }
            
            // Get both canvas elements
            const trxCanvas = document.getElementById('trxChart');
            const usdCanvas = document.getElementById('usdChart');
            
            if (!trxCanvas || !usdCanvas) {
                console.error('Chart canvases not found');
                return;
            }
            
            const trxCtx = trxCanvas.getContext('2d');
            const usdCtx = usdCanvas.getContext('2d');
            
            // Clear both canvases
            trxCtx.clearRect(0, 0, trxCanvas.width, trxCanvas.height);
            usdCtx.clearRect(0, 0, usdCanvas.width, usdCanvas.height);
            
            // Get data for calculations
            const trxAmount = parseFloat(document.getElementById('trxAmount').value) || 0;
            const periods = window.calculationBreakdown;
            const growthParams = getGrowthParameters();
            const initialTRXPrice = currentTRXPrice || 0;
            const claimDays = getClaimFrequencyDays();
            
            // Calculate TRX values
            const trxValues = [trxAmount, ...periods.map(p => p.finalAmount)];
            const maxTRXAmount = Math.max(...trxValues);
            const minTRXAmount = Math.min(...trxValues);
            
            // Calculate USD values for each period
            const usdValues = [];
            usdValues.push(trxAmount * initialTRXPrice); // Initial amount
            
            periods.forEach((period, index) => {
                const periodDay = (index + 1) * claimDays;
                let trxPrice = initialTRXPrice;
                if (growthParams && growthParams.enabled && initialTRXPrice > 0) {
                    trxPrice = calculateTRXPriceAtDay(periodDay, initialTRXPrice, growthParams);
                }
                usdValues.push(period.finalAmount * trxPrice);
            });
            
            const maxUSDAmount = Math.max(...usdValues);
            const minUSDAmount = Math.min(...usdValues);
            
            // Generate TRX Chart
            generateSingleChart(trxCtx, trxCanvas, trxValues, minTRXAmount, maxTRXAmount, 'TRX', '#52d273');
            
            // Generate USD Chart
            generateSingleChart(usdCtx, usdCanvas, usdValues, minUSDAmount, maxUSDAmount, 'USD', '#ce9178');
            
            // Update legend
            const legendEl = document.getElementById('chartLegend');
            const totalTRXGrowth = ((trxValues[trxValues.length - 1] / trxAmount) - 1) * 100;
            const totalUSDGrowth = ((usdValues[usdValues.length - 1] / usdValues[0]) - 1) * 100;
            
            legendEl.innerHTML = `
                <div style="display: flex; justify-content: center; align-items: center; gap: 30px; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <div style="width: 12px; height: 12px; background: #52d273; border-radius: 2px;"></div>
                        <span>TRX Growth: ${totalTRXGrowth.toFixed(1)}%</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <div style="width: 12px; height: 12px; background: #ce9178; border-radius: 2px;"></div>
                        <span>USD Growth: ${totalUSDGrowth.toFixed(1)}%</span>
                    </div>
                    <div style="color: var(--muted);">
                        Claim/Reinvest every ${claimDays} days
                    </div>
                </div>
            `;
        }
        
        function generateSingleChart(ctx, canvas, values, minAmount, maxAmount, unit, color) {
            // Chart dimensions and margins
            const margin = { top: 30, right: 40, bottom: 50, left: 80 };
            const chartWidth = canvas.width - margin.left - margin.right;
            const chartHeight = canvas.height - margin.top - margin.bottom;
            
            // Scale functions
            const xScale = (index) => margin.left + (index / (values.length - 1)) * chartWidth;
            const yScale = (amount) => margin.top + (1 - (amount - minAmount) / (maxAmount - minAmount)) * chartHeight;
            
            // Calculate smart label spacing
            const maxLabels = 8;
            const labelStep = Math.max(1, Math.ceil(values.length / maxLabels));
            
            // Set canvas styles
            ctx.fillStyle = '#e9f0ff';
            ctx.font = '10px JetBrains Mono';
            ctx.textAlign = 'center';
            
            // Draw grid lines and labels
            ctx.strokeStyle = 'rgba(255,255,255,0.1)';
            ctx.lineWidth = 1;
            ctx.fillStyle = '#9fb0d0';
            
            // Y-axis labels and grid
            for (let i = 0; i <= 5; i++) {
                const value = minAmount + (maxAmount - minAmount) * (i / 5);
                const y = yScale(value);
                
                // Grid line
                ctx.beginPath();
                ctx.moveTo(margin.left, y);
                ctx.lineTo(margin.left + chartWidth, y);
                ctx.stroke();
                
                // Label
                ctx.textAlign = 'right';
                const labelText = unit === 'USD' ? '$' + formatNumber(value) : formatNumber(value);
                ctx.fillText(labelText, margin.left - 10, y + 4);
            }
            
            // X-axis labels and grid
            ctx.textAlign = 'center';
            for (let i = 0; i < values.length; i++) {
                const x = xScale(i);
                
                // Grid line
                ctx.beginPath();
                ctx.moveTo(x, margin.top);
                ctx.lineTo(x, margin.top + chartHeight);
                ctx.stroke();
                
                // Label - show every labelStep or first/last
                if (i % labelStep === 0 || i === 0 || i === values.length - 1) {
                    ctx.fillText(`P${i}`, x, margin.top + chartHeight + 20);
                }
            }
            
            // Draw area chart
            ctx.fillStyle = color + '33'; // Add transparency
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            
            ctx.beginPath();
            ctx.moveTo(xScale(0), yScale(values[0]));
            
            // Draw the growth line
            values.forEach((value, index) => {
                ctx.lineTo(xScale(index), yScale(value));
            });
            
            // Close the area
            ctx.lineTo(xScale(values.length - 1), margin.top + chartHeight);
            ctx.lineTo(xScale(0), margin.top + chartHeight);
            ctx.closePath();
            ctx.fill();
            
            // Draw the line
            ctx.beginPath();
            ctx.moveTo(xScale(0), yScale(values[0]));
            values.forEach((value, index) => {
                ctx.lineTo(xScale(index), yScale(value));
            });
            ctx.stroke();
            
            // Draw data points
            ctx.fillStyle = color;
            values.forEach((value, index) => {
                const x = xScale(index);
                const y = yScale(value);
                ctx.beginPath();
                ctx.arc(x, y, 3, 0, 2 * Math.PI);
                ctx.fill();
            });
            
            // Draw axes
            ctx.strokeStyle = '#e9f0ff';
            ctx.lineWidth = 2;
            
            // Y-axis
            ctx.beginPath();
            ctx.moveTo(margin.left, margin.top);
            ctx.lineTo(margin.left, margin.top + chartHeight);
            ctx.stroke();
            
            // X-axis
            ctx.beginPath();
            ctx.moveTo(margin.left, margin.top + chartHeight);
            ctx.lineTo(margin.left + chartWidth, margin.top + chartHeight);
            ctx.stroke();
            
            // Axis labels
            ctx.fillStyle = '#e9f0ff';
            ctx.font = '11px JetBrains Mono';
            ctx.textAlign = 'center';
            
            // X-axis label
            ctx.save();
            ctx.translate(margin.left + chartWidth / 2, canvas.height - 15);
            ctx.fillText('Periods', 0, 0);
            ctx.restore();
            
            // Y-axis label
            ctx.save();
            ctx.translate(25, margin.top + chartHeight / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText(unit === 'USD' ? 'USD Value' : 'TRX Balance', 0, 0);
            ctx.restore();
        }
    </script>
</body>
</html>


